import{_ as Ia,r as U,o as f,p as j,f as o,bJ as ro,w as t,d as C,e as q,k as $,t as z,l as ya,Q as W,m as no,s as lo,bf as Ma,H as ea,P as fa,F as H,x as J,S as K,T as N,j as Q,N as ia,q as so,A as uo,M as za,E as co,G as Ba,h as Ta,i as Na,I as Aa,J as Oa,K as Ka,br as Ra,D as Sa,a as mo,cN as fo,cO as po,cP as vo,cQ as ho,U as G,C as wa,B as ka,aU as go}from"./index.0b6a0fa4.js";import{D as bo,C as Co}from"./DocumentosFiscais.904fdd5e.js";import{V as Fo}from"./VendaCard.b37b70c0.js";import{E as $o}from"./EnvelopeCard.95505e67.js";import{e as Do}from"./emitirNFe.35117289.js";const Eo={computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{width:0,tituloOriginal:{},titulo:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,campos:{valorMulta:0},rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(r){this.$router.push({name:"AtendimentoFatura",params:{id:r}})},async migrarFatura(r){try{await new Promise((e,u)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{u()})})}catch{return}if(!r&&this.titulo.idContato&&this.titulo.idEmpresa){const e=await $erp().contato.get(this.titulo.idContato)||{};let u=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),D=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();u=u.find(I=>(I.grupo||"").trim().toLowerCase()==="Principal")||u[0]||{},D=D.find(I=>(I.tipoTelefone||"").trim().toLowerCase()==="Principal")||D[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let c=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();c=c.find(I=>I.grupo.trim().toLowerCase()==="Principal")||c[0]||{},r=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:c.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:e.id,idContatoEndereco:u.id||"",numeroDocumentoContato:e.numeroDocumentoNacional||"",descricaoContato:e.nome||"",descricaoContatoEndereco:"".concat(u.logradouro||"",", ",u.numero||""," ",u.complemento||""," - ",u.bairro||""," - ",u.cep||""," - ",u.municipio||"","/",u.uf||""),telefoneContato:D.telefone||"",emailContato:e.email||"",regimeContato:e.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:r})}r.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:r.id},original:this.titulo}),localStorage.setItem("idFatura",r.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(this.titulo.valorDesconto===this.tituloOriginal.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){const r=Number(this.titulo.diasEmAtraso)||0;let e=0;r>0&&(e=Number(this.titulo.valorMulta)||0),this.modalEditar={visivel:!0,campos:{valorMulta:e},rules:[]}},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},cancelarDesconto(){this.titulo=$utils.clonar(this.tituloOriginal),this.modalEditar.visivel=!1},async desconto(){const r=this.titulo.valorDesconto;let e=0,u=0,D=0,a=Number(this.titulo.diasEmAtraso)||0;const c=Number(this.titulo.valor)||0;if(a<0&&(a=0),a>0&&(u=Number(this.titulo.valorMulta)||0,e=Number(this.titulo.valorJuros)||0,D=$utils.arredondar(u+e*a)),await $db.permissao.objeto("PadraoNovo_Financeiro")&&(D=$utils.arredondar(c+u+e*a)),r<0||r>D){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"];return}this.modalEditar.rules=[()=>!0];const n=$utils.arredondar(c-r+u+e*a),m=$utils.arredondar(r*100/(c||1));this.titulo.valorTotal=n,this.titulo.valorARealizar=n,this.titulo.percentualDesconto=m},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((r,e)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{r()}).onCancel(()=>{e()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")},onResize(){this.width=window.innerWidth}},props:{dados:{required:!0,type:Object}},async mounted(){const r=new Date(this.dados.dataVencimento).setHours(0,0,0,0),e=new Date().setHours(0,0,0,0);r<e?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,D=>D!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $db.hibrido.le({table:"documento",id:this.titulo.documentoId})),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(D=>this.visibilidade.botao.editar=D&&!this.tituloOriginal.valorRealizado),this.contatos={};const u={};if(this.titulo.idContato){const D=await $db.contato.le({id:this.titulo.idContato});D&&(u[this.titulo.idContato]=D)}if(this.titulo.idEmpresa){const D=await $db.contato.le({id:this.titulo.idEmpresa});D&&(u[this.titulo.idEmpresa]=D)}this.contatos=u,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leV2({id:this.titulo.idFatura}).then(D=>{this.fatura=D,D.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(I=>I.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},wo={id:"TituloCard"};function yo(r,e,u,D,a,c){const I=U("BadgeCopiarUid"),n=U("badge"),m=U("g-col"),S=U("avatar"),v=U("g-label"),B=U("g-row"),O=U("campo");return f(),j("div",wo,[o(ro,{onResize:c.onResize},null,8,["onResize"]),o(uo,{class:so(["extratoItem bg-white no-shadow",a.tema])},{default:t(()=>[o(B,{gutter:"sm",items:"center",justify:"between"},{default:t(()=>[o(m,{col:"12",text:"right",class:"hideondesktop"},{default:t(()=>{var w,i,E,y,h,p;return[o(I,{numero:(w=a.titulo)==null?void 0:w.documentoCodigo,id:(i=a.titulo)==null?void 0:i.id,escuro:"",icone:"mdi-file-document",cor:"positive",class:"q-mr-xs"},null,8,["numero","id"]),a.titulo.parcela?(f(),C(n,{key:0,rotulo:a.titulo.parcela,escuro:"",cor:"tertiary",class:"q-mr-xs"},null,8,["rotulo"])):q("",!0),(E=a.titulo)!=null&&E.documentoCodigo?(f(),C(I,{key:1,numero:(y=a.documento)==null?void 0:y.numero,escuro:"",id:(h=a.documento)==null?void 0:h.id,dica:(p=a.titulo)==null?void 0:p.documentoTipo,cor:"tertiary",class:"q-mr-xs"},null,8,["numero","id","dica"])):q("",!0)]}),_:1}),o(m,{col:"12 sm5"},{default:t(()=>[o(B,{items:"center"},{default:t(()=>[o(m,{col:"shrink",self:a.width<=992?"top":"center"},{default:t(()=>{var w,i;return[o(S,{imagem:(w=a.contatos[a.titulo.idContato])==null?void 0:w.imagem,rotulo:(i=a.contatos[a.titulo.idContato])==null?void 0:i.apelido,tamanho:"40"},null,8,["imagem","rotulo"])]}),_:1},8,["self"]),o(m,null,{default:t(()=>[o(v,{text:"body1 medium"},{default:t(()=>{var w;return[$(z((w=a.contatos[a.titulo.idContato])==null?void 0:w.apelido)+" ",1),o(v,{caption:""},{default:t(()=>{var i;return[$(z((i=a.contatos[a.titulo.idContato])==null?void 0:i.nome),1)]}),_:1})]}),_:1})]),_:1})]),_:1})]),_:1}),o(m,{col:"sm3",class:"hideonmobile"},{default:t(()=>{var w,i,E,y,h,p,s,x;return[o(I,{numero:(w=a.titulo)==null?void 0:w.documentoCodigo,id:(i=a.titulo)==null?void 0:i.id,escuro:"",icone:"mdi-file-document",cor:"positive",class:"q-mr-xs"},null,8,["numero","id"]),a.titulo.parcela?(f(),C(n,{key:0,rotulo:a.titulo.parcela,escuro:"",cor:"tertiary",class:"q-mr-xs"},null,8,["rotulo"])):q("",!0),(E=a.titulo)!=null&&E.documentoCodigo?(f(),C(I,{key:1,numero:(y=a.documento)==null?void 0:y.numero,escuro:"",id:(h=a.documento)==null?void 0:h.id,dica:(p=a.titulo)==null?void 0:p.documentoTipo,cor:"tertiary",class:"q-mr-xs"},null,8,["numero","id","dica"])):q("",!0),((s=a.titulo)==null?void 0:s.formaDePagamento)||((x=a.titulo)==null?void 0:x.descricaoPlanoConta)?(f(),C(v,{key:2,text:"sub2 regular"},{default:t(()=>{var Z,b;return[$(z((Z=a.titulo)==null?void 0:Z.formaDePagamento)+" ",1),(b=a.titulo)!=null&&b.descricaoPlanoConta?(f(),C(v,{key:0,caption:""},{default:t(()=>{var A;return[$(" Descri\xE7\xE3o do plano de conta"+z((A=a.titulo)==null?void 0:A.descricaoPlanoConta),1)]}),_:1})):q("",!0)]}),_:1})):q("",!0)]}),_:1}),o(m,{col:"5 sm-shrink md2"},{default:t(()=>{var w,i;return[(w=a.titulo)!=null&&w.dataVencimentoOriginal?(f(),C(v,{key:0,icon:"mdi-calendar-today",tip:"Vencimento original"},{default:t(()=>{var E;return[$(z(r.$filters.data((E=a.titulo)==null?void 0:E.dataVencimentoOriginal)),1)]}),_:1})):q("",!0),(i=a.titulo)!=null&&i.dataVencimento?(f(),C(v,{key:1,icon:"mdi-calendar-check",tip:"Vencimento"},{default:t(()=>{var E;return[$(z(r.$filters.data((E=a.titulo)==null?void 0:E.dataVencimento)),1)]}),_:1})):q("",!0)]}),_:1}),o(m,{col:"7 sm md2"},{default:t(()=>[o(v,{text:"h5 right bold",color:a.titulo.valorTotal>0?"text-positive":"text-negative"},{default:t(()=>[$(z(r.$filters.numero(a.titulo.valorTotal,2)),1)]),_:1},8,["color"]),o(v,{text:"body right medium"},{default:t(()=>[$(z(r.$filters.numero(a.titulo.valor,2)),1)]),_:1})]),_:1})]),_:1}),o(ya,{class:"q-mx-sm q-mb-xs"}),o(B,{gutter:"sm",items:"center"},{default:t(()=>[o(m,{col:"12 md"},{default:t(()=>[o(v,{text:"body2 regular"},{default:t(()=>[$(z(a.titulo.descricao),1)]),_:1})]),_:1}),o(m,{col:"12 md3",text:"right",self:"end"},{default:t(()=>[o(W,{onClick:c.alternarDetalhes,round:"",dense:"",flat:"",color:"tertiary",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`},null,8,["onClick","icon"]),a.visibilidade.botao.remover?(f(),C(W,{key:0,onClick:c.remover,round:"",dense:"",flat:"",icon:"clear",color:"tertiary"},{default:t(()=>[o(no,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[$(" Remover da Fatura #"+z(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):q("",!0),a.visibilidade.botao.editar?(f(),C(W,{key:1,onClick:c.editar,round:"",dense:"",flat:"",icon:"edit",color:"primary"},null,8,["onClick"])):q("",!0),lo(r.$slots,"default",{},void 0,!0),c.mostrarMenuTresPontos?(f(),C(W,{key:2,icon:"more_vert",color:"tertiary",rounded:"",dense:"",flat:""},{default:t(()=>[o(Ma,null,{default:t(()=>[ea((f(),C(fa,{link:"",separator:""},{default:t(()=>[a.mostrarOpcaoMigrarFatura?(f(),j(H,{key:0},[(f(!0),j(H,null,J(a.faturasAbertas,w=>(f(),C(K,{key:w.id,onClick:i=>c.migrarFatura(w),clickable:""},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"mdi-folder-move"})]),_:1}),o(N,null,{default:t(()=>[$(z("Migrar para fatura #"+(w.numero||w.id.slice(-6))),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),o(K,{clickable:"",onClick:e[0]||(e[0]=w=>c.migrarFatura())},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"mdi-folder-move"})]),_:1}),o(N,null,{default:t(()=>e[8]||(e[8]=[$("Migrar para nova fatura")])),_:1})]),_:1})],64)):q("",!0)]),_:1})),[[ia]])]),_:1})]),_:1})):q("",!0)]),_:3})]),_:3}),a.detalhes?(f(),C(B,{key:0,gutter:"sm",items:"stretch"},{default:t(()=>[o(m,{col:"12 sm12 md-grow",bordered:"","rounded-borders":""},{default:t(()=>{var w,i;return[o(B,{gutter:"none"},{default:t(()=>[o(m,{col:"12 sm6"},{default:t(()=>{var E;return[(E=a.contatos[a.titulo.idEmpresa])!=null&&E.apelido?(f(),C(v,{key:0,text:"sub2 medium",icon:`business ${a.width<=992?"15px":"xs"} tertiary left`},{default:t(()=>{var y;return[$(z((y=a.contatos[a.titulo.idEmpresa])==null?void 0:y.apelido),1)]}),_:1},8,["icon"])):q("",!0)]}),_:1}),o(m,{col:"12 sm6"},{default:t(()=>{var E;return[(E=a.titulo)!=null&&E.documentoCodigo?(f(),C(v,{key:0,text:"sub2 medium",inline:"",icon:`request_quote ${a.width<=992?"15px":"xs"} tertiary left`},{default:t(()=>{var y,h,p;return[$(z((y=a.titulo)==null?void 0:y.documentoTipo)+" ",1),o(I,{id:(h=a.documento)==null?void 0:h.id,escuro:"",cor:"positive",numero:(p=a.documento)==null?void 0:p.numero,class:"q-mx-sm"},null,8,["id","numero"])]}),_:1},8,["icon"])):q("",!0)]}),_:1})]),_:1}),(w=a.titulo)!=null&&w.observacao?(f(),C(v,{key:0,text:"sub2",class:"q-mt-sm"},{default:t(()=>[e[9]||(e[9]=$(" Obs.: ")),o(v,{inline:"",text:"regular"},{default:t(()=>{var E;return[$(z((E=a.titulo)==null?void 0:E.observacao),1)]}),_:1})]),_:1})):q("",!0),(i=a.titulo)!=null&&i.descricaoCentroCusto?(f(),C(v,{key:1,text:"sub2",class:"q-mt-sm"},{default:t(()=>[e[10]||(e[10]=$(" Desc.: ")),o(v,{inline:"",text:"regular"},{default:t(()=>{var E;return[$(z((E=a.titulo)==null?void 0:E.descricaoCentroCusto),1)]}),_:1})]),_:1})):q("",!0)]}),_:1}),o(m,{col:"12 sm6 md2",bordered:"","rounded-borders":""},{default:t(()=>[o(B,null,{default:t(()=>[o(m,{col:"6 md12"},{default:t(()=>{var w;return[(w=a.titulo)!=null&&w.dataEmissao?(f(),C(v,{key:0,text:"sub2",icon:"mdi-calendar-today",tip:"Emiss\xE3o"},{default:t(()=>{var i;return[$(z(r.$filters.data((i=a.titulo)==null?void 0:i.dataEmissao))+" ",1),o(v,{caption:""},{default:t(()=>e[11]||(e[11]=[$("Emiss\xE3o")])),_:1})]}),_:1})):q("",!0)]}),_:1}),o(m,{col:"6 md12"},{default:t(()=>{var w;return[(w=a.titulo)!=null&&w.dataCompetencia?(f(),C(v,{key:0,icon:"mdi-calendar-check",tip:"Compet\xEAncia",text:"sub2"},{default:t(()=>{var i;return[$(z(r.$filters.data((i=a.titulo)==null?void 0:i.dataCompetencia))+" ",1),o(v,{caption:""},{default:t(()=>e[12]||(e[12]=[$("Compet\xEAncia")])),_:1})]}),_:1})):q("",!0)]}),_:1})]),_:1})]),_:1}),o(m,{col:"12 sm6 md3",bordered:"","rounded-borders":""},{default:t(()=>{var w,i;return[o(v,{text:"sub2",bordered:"bottom"},{default:t(()=>[e[13]||(e[13]=$(" Desconto ")),o(v,{text:"bold right",class:"float-right",inline:""},{default:t(()=>{var E;return[$(z(r.$filters.numero(((E=a.titulo)==null?void 0:E.valorDesconto)||0,2)),1)]}),_:1})]),_:1}),(w=a.titulo)!=null&&w.diasEmAtraso?(f(),C(v,{key:0,text:"sub2 medium",bordered:"bottom",class:"q-mt-sm"},{default:t(()=>[e[14]||(e[14]=$(" Multa ")),o(v,{text:"bold right",class:"float-right",inline:""},{default:t(()=>{var E,y;return[$(z(r.$filters.numero(((E=a.titulo)==null?void 0:E.valorMulta)||0,2))+" ("+z(r.$filters.numero(((y=a.titulo)==null?void 0:y.percentualMulta)||0,2))+"%) ",1)]}),_:1})]),_:1})):q("",!0),(i=a.titulo)!=null&&i.diasEmAtraso?(f(),C(v,{key:1,text:"sub2 medium",bordered:"bottom",class:"q-mt-sm"},{default:t(()=>[e[15]||(e[15]=$(" Juros ")),o(v,{text:"bold right",class:"float-right",inline:""},{default:t(()=>{var E,y;return[$(z(r.$filters.numero(((E=a.titulo)==null?void 0:E.valorTotalJuros)||0,2))+" ("+z(r.$filters.numero(((y=a.titulo)==null?void 0:y.percentualJuros)||0,2))+"% dia) ",1)]}),_:1})]),_:1})):q("",!0)]}),_:1})]),_:1})):q("",!0)]),_:3},8,["class"]),o(Sa,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":e[7]||(e[7]=w=>a.modalEditar.visivel=w),onKeyup:Ra(c.cancelarDesconto,["esc"]),persistent:""},{default:t(()=>[o(za,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"500px"}},{default:t(()=>[o(co,{onSubmit:c.salvar},{default:t(()=>[o(Ba,{class:"bg-white text-tertiary border-bottom"},{default:t(()=>[o(Ta,{class:"bg-primary text-white"},{default:t(()=>[o(Na,null,{default:t(()=>e[16]||(e[16]=[$("Editar T\xEDtulo")])),_:1}),ea(o(W,{icon:"close",round:"",flat:""},null,512),[[ia]])]),_:1})]),_:1}),o(Aa,null,{default:t(()=>[o(Oa,null,{default:t(()=>[o(B,{gutter:"md",bg:"bg-white"},{default:t(()=>[o(m,{col:"12"},{default:t(()=>[o(O,{modelValue:a.titulo.valor,"onUpdate:modelValue":e[1]||(e[1]=w=>a.titulo.valor=w),"somente-leitura":"",filled:"",tipo:"decimal",rotulo:"Valor",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue"]),o(O,{modelValue:a.titulo.diasEmAtraso,"onUpdate:modelValue":e[2]||(e[2]=w=>a.titulo.diasEmAtraso=w),zeros:"","somente-leitura":"",filled:"",tipo:"decimal",rotulo:"Dias em Atraso",decimals:"0",zerosDireita:"0",class:"q-field--with-bottom"},null,8,["modelValue"]),o(O,{modelValue:a.modalEditar.campos.valorMulta,"onUpdate:modelValue":e[3]||(e[3]=w=>a.modalEditar.campos.valorMulta=w),"somente-leitura":"",filled:"",ajuda:`Multa de R$ ${r.$filters.numero(a.titulo.valorMulta,2)}`,rotulo:"Multa",tipo:"decimal",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue","ajuda"]),o(O,{modelValue:a.titulo.valorTotalJuros,"onUpdate:modelValue":e[4]||(e[4]=w=>a.titulo.valorTotalJuros=w),"somente-leitura":"",filled:"",ajuda:`Juros ao ${a.titulo.tipoJuros} de R$ ${r.$filters.numero(a.titulo.valorJuros,2)}`,rotulo:"Juros",tipo:"decimal",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue","ajuda"]),o(O,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[e[5]||(e[5]=w=>a.titulo.valorDesconto=w),c.desconto],rules:a.modalEditar.rules,filled:"",rotulo:"Desconto",tipo:"decimal",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue","onUpdate:modelValue","rules"]),o(O,{modelValue:a.titulo.valorTotal,"onUpdate:modelValue":e[6]||(e[6]=w=>a.titulo.valorTotal=w),filled:"",tipo:"decimal",rotulo:"Total",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),o(Ka,{class:"bg-white text-right border-top q-pa-sm"},{default:t(()=>[o(W,{onClick:c.cancelarDesconto,flat:"",unelevated:"",label:"Cancelar",color:"tertiary"},null,8,["onClick"]),o(W,{type:"submit",unelevated:"",label:"Salvar",color:"primary"})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue","onKeyup"])])}var To=Ia(Eo,[["render",yo],["__scopeId","data-v-53008a31"]]),Po={async enviar(r,e){var u,D,a;try{const c=(u=e.valor)!=null?u:"Impresso";$q.loading.show({message:`Enviando ${c} por e-mail...`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const I=e.nome.replace("enviaemail.fatura.",""),n=(D=e.texto)!=null?D:`Voc\xEA est\xE1 recebendo o ${c} da empresa ${r.descricaoEmpresa}.`,m=await $db.contato.le({id:r.idContato}),S=await $utils.impressaoObterHtml(I,r),v={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:String(m==null?void 0:m.email).trim().toLowerCase(),assunto:`${c}`,mensagem:`${n}`},B=`${c} enviado para ${v.para}, com sucesso!.`,O=[{name:`${c}.pdf`,content:S,method:"html2pdf"}],w={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"drab azmd uvtf izhd"},from:v.de,to:v.para,subject:v.assunto,text:v.mensagem,attachments:O},i=await mo({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:w});$q.notifyPositive((i==null?void 0:i.status)===200&&B?B:i.data.message)}catch(c){$q.notifyError(`Erro ao enviar e-mail. ${(a=e.valor)!=null?a:"Impresso"} n\xE3o enviado.`,c)}finally{$q.loading.hide()}}},xo={async finalizar(r,e){var u,D,a,c,I,n,m,S,v,B,O,w;try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!r)try{await new Promise((l,d)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{l()}).onCancel(()=>{d()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const i=$utils.clonar(this.fatura),E=$utils.clonar(this.vendas),y=$utils.clonar(this.documentosEnvelope),h=$utils.clonar(this.carnes),p=[...E,...y].map(l=>l.id),s=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:p}}),x=$utils.clonar(s),Z=$utils.arredondar((i.totalDesconto||0)+(i.totalBonus||0));if(h.length>0){const l=h.reduce((d,T)=>(T.idFinanceiroBoleto&&T.codigoFinanceiroTitulo&&(d+=String(T.codigoFinanceiroTitulo)+";"),d),"");if(l)try{$q.loading.show({message:"Baixando boletos..."});const d=`exec sp_Financeiro_BoletoBaixar '${l.slice(0,-1)}'`,T=await $utils.executarSql(d)}catch(d){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",d);return}finally{$q.loading.hide()}}const b=r?i.dataHoraFinalizado:$utils.dataAtual(),A=b,V=await $db.hibrido.le({table:"documento",id:this.$refs.faturamento.idDocumentoCaixa}),ga=await $db.formaPagamento.le();this.documentoStatus=[],await this.$refs.faturamento.validar();let Y=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(l=>l.valor),["idFormaPagamento","autorizacao","dataVencimento"]);if($utils.verificarErro(E.some(l=>!l.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o."),i.tokenBonusUtilizado){const l=await $utils.geeksApi({utilizaBonus:{funcao:"1A130FC6-C9BA-4121-B9CF-069CEAEC36CB",tokenBonus:i.tokenBonusUtilizado,valorVenda:(i.subTotal||0)-(i.totalDesconto||0),cnpjEmissor:i.numeroDocumentoEmpresa,cpfCliente:i.numeroDocumentoContato,idDocumentoDestino:i.id,utiliza:!0}});$utils.verificarErro(((D=(u=l.data)==null?void 0:u.utilizaBonus)==null?void 0:D.status)!=="Utilizado","B\xF4nus inv\xE1lido"),$utils.verificarErro(!((c=(a=l.data)==null?void 0:a.utilizaBonus)!=null&&c.valor),"Valor do B\xF4nus inv\xE1lido")}const ra=$utils.arredondar(this.carnes.reduce((l,d)=>l+(d.valorARealizar||0),0)),na=$utils.arredondar(Y.reduce((l,d)=>l+(d.valor||0),0));let da=0;if(r&&(Y=Y.filter(l=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(d=>d.id===l.id))),i.totalDocumento>=0){if(this.carnes.length){if(na<ra)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const d=Y.reduce((T,P)=>{const k=`${P.autorizacao||""}${P.documento||""}${P.idFormaPagamento}`;return T[k]||(T[k]={parcelas:0,formaPagamento:P.formaPagamento}),T[k].parcelas++,T},{});for(const T in d)if(d[T].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${d[T].formaPagamento} acima do permitido.`),!1}}na<i.totalDocumento&&(da=1)}let ca=da===1?"Aguardando Pagamento":"Finalizada";if(!r){this.documentoStatus.push({id:$utils.uuid(),idDocumento:i.id,operacao:"Fatura",statusOriginal:i.status,statusFinalizado:ca,dataHoraEmissao:b,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:V.id||""}),i.status=ca,i.dataHoraFinalizado=b,ca="Faturado";const l=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",i.idEmpresa,0))||0;let d=0,T=y.filter(g=>g.status!=="Entregue").length,P=!1,k=!0;if(E.length>0&&l&&(this.$q.loading.hide(),await new Promise((g,_)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{k=!0,g()}).onCancel(()=>{k=!1,g()})}),this.$q.loading.show({message:"Processando..."})),T){let g="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";T>1&&(g=`Nesta Fatura h\xE1 ${T} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise((_,M)=>{this.$q.dialog({cancel:"N\xE3o",message:g,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{P=!0,_()}).onCancel(()=>{M()})})}catch{}this.$q.loading.show({message:"Processando..."})}let F=0;for(const g of x)g.total>0&&(F+=(g.valorItem-g.descontoItem)*g.quantidade-g.descontoTotalRateado);for(const g of[...E,...y])g.tipo==="Envelope"&&P&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:g.id,operacao:g.operacao,statusOriginal:g.status,statusFinalizado:"Entregue",dataHoraEmissao:b,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),g.status="Entregue"),g.tipo==="Venda"&&k&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:g.id,operacao:g.operacao,statusOriginal:g.status,statusFinalizado:ca,dataHoraEmissao:b,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:V.id||""}),g.status="Faturado");for(const g of x){const _=[...E,...y].find(M=>M.id===g.idDocumento);if(g.status=_.status,g.total>0){g.quantidade=g.quantidade||1,g.valorItem=g.valorItem||0,g.descontoItem=g.descontoItem||0,g.descontoTotalRateado=g.descontoTotalRateado||0;let M=(g.valorItem-g.descontoItem)*g.quantidade-g.descontoTotalRateado;const R=$utils.arredondar(Z*M/(F||1)||0);g.descontoFaturaRateado=$utils.arredondar(R),g.valorRealTotal=$utils.arredondar(M-R),g.valorReal=$utils.arredondar(g.valorRealTotal/g.quantidade),d+=R}}if(this.documentosItem=x,this.documentosItemOriginal=s,Z!==$utils.arredondar(d)){const g=$utils.arredondar(Z-(d||0));let _,M=0;for(const R of x)R.total>M&&(M=R.total,_=R);if(_){const R=(_.descontoFaturaRateado||0)+(g||0),ta=((_.valorItem||0)-(_.descontoItem||0))*(_.quantidade||1)-(_.descontoTotalRateado||0)-(R||0),va=(ta||0)/(_.quantidade||1);_.descontoFaturaRateado=$utils.arredondar(R),_.valorReal=$utils.arredondar(va),_.valorRealTotal=$utils.arredondar(ta)}}}const Pa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),ba=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Pa}),Wa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let pa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Wa});const Za=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),ja=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Za}),Xa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),La=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Xa}),Ya=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ya}),ao=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Ua=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ao}),oo=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),Ha=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:oo}),to=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),$a=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:to}),eo=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),io=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:eo}),xa=(I=this.contatos[i.idContato])==null?void 0:I.descontoCondicionadoPercentual,qa=await $db.configuracoes.leValorNumerico("contabilidade.versao")!==2;let ma=E.reduce((l,d)=>l+d.totalDocumento,0);ma=ma+y.reduce((l,d)=>l+d.totalDocumento,0),ma=$utils.arredondar(ma-Z);let ua=i.totalDocumento,oa=[];const L=[],Ja=[],Da=[],Qa=[];let Ca=1,_a="",Ea=1,la="";for(const l of Y.filter(d=>!d.sinal)){l.sinal=l.sinal||da;const d=ga.filter(T=>T.id===l.idFormaPagamento)[0];if(ua<0)la=$utils.uuid(),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:la,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:b,valorCredito:0,valorDebito:$utils.arredondar(ua*-1),descricao:aa.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${i.id})`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:l.dataVencimento,dataMovimento:l.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:la,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:io.id,dataEmissao:b,valorCredito:$utils.arredondar(ua*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${i.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:l.dataVencimento,dataMovimento:l.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id});else{if(_a!==l.idFormaPagamento+l.autorizacao&&(_a=l.idFormaPagamento+l.autorizacao,Ca=1,Ea=Y.reduce((T,P)=>P.idFormaPagamento+P.autorizacao===_a?T+1:T,0)),d.tipoFinanceiro==="T\xEDtulo Liquidado"&&(la=$utils.uuid()),ra>0){const T=$utils.uuid(),P=$utils.arredondar(l.valor*(ra/ua));let k=0,F=0,g=0,_=0;if(d.tipo===5){let M=(await $erp().financeiroBanco.toArray()).find(R=>R.codigoBanco===122);M&&(F=M.percentualMulta||0,_=M.percentualJuros||0,k=$utils.arredondar(F/100*P),g=$utils.arredondar(_/100*P))}oa.push({id:T,idFinanceiroPlanoConta:ba.id,idContato:i.idContato,dataEmissao:b,dataCompetencia:A,dataVencimento:l.dataVencimento,dataVencimentoOriginal:l.dataVencimento,valor:P,valorTotal:P,valorARealizar:P,valorMulta:k,percentualMulta:F,valorJuros:g,percentualJuros:_,documentoId:i.id,documentoTipo:"Fatura",parcela:Ca+"/"+Ea,descricao:"Fatura de Venda Mercadoria",observacao:`${i.observacaoFaturamento||""} ${l.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:d.descricao,carne:d.tipo===5?1:0,dataEmissaoCarne:d.tipo===5?b:"",idDocumentoCaixa:V.id,idFinanceiroMovimentacaoAgrupamento:d.tipoFinanceiro==="T\xEDtulo Liquidado"?la:""}),l.idFinanceiroTitulo=T,d.tipo===2&&Da.push({idTitulo:T,idDocumentoCondicaoPagamento:l.id,valor:P,dataVencimento:l.dataVencimento,idBanco:l.idBanco,agencia:l.agencia,conta:l.conta,numeroCheque:l.numeroCheque,formaPagamento:d}),Qa.push({idTitulo:T,valor:P,desconto:0})}if(ma>0){const T=$utils.uuid(),P=$utils.arredondar(l.valor*(ma/ua));let k=0,F=0,g=0,_=0;if(d.tipo===5){let M=(await $erp().financeiroBanco.toArray()).find(R=>R.codigoBanco===122);M&&(F=M.percentualMulta||0,_=M.percentualJuros||0,k=$utils.arredondar(F/100*P),g=$utils.arredondar(_/100*P))}oa.push({id:T,idFinanceiroPlanoConta:aa.id,idContato:i.idContato,dataEmissao:b,dataCompetencia:A,dataVencimento:l.dataVencimento,dataVencimentoOriginal:l.dataVencimento,valor:P,valorTotal:P,valorARealizar:P,valorMulta:k,percentualMulta:F,valorJuros:g,percentualJuros:_,documentoId:i.id,documentoTipo:"Fatura",parcela:Ca+"/"+Ea,descricao:"Fatura de Venda Mercadoria",observacao:`${i.observacaoFaturamento||""} ${l.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:d.descricao,carne:d.tipo===5?1:0,dataEmissaoCarne:d.tipo===5?b:"",idDocumentoCaixa:V.id,idFinanceiroMovimentacaoAgrupamento:d.tipoFinanceiro==="T\xEDtulo Liquidado"?la:"",descontoCondicionadoValor:xa>0?xa/100*P:0,descontoCondicionadoPercentual:xa}),l.idFinanceiroTitulo=T,d.tipo===2&&Da.push({idTitulo:T,idDocumentoCondicaoPagamento:l.id,valor:P,dataVencimento:l.dataVencimento,idBanco:l.idBanco,agencia:l.agencia,conta:l.conta,numeroCheque:l.numeroCheque,formaPagamento:d})}if(d.tipoFinanceiro==="T\xEDtulo Liquidado"&&ma>=0){L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:la,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:pa.id,idFinanceiroTitulo:l.idFinanceiroTitulo,dataEmissao:b,valorCredito:l.valor,valorDebito:0,descricao:String(pa.descricao).trim(),observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:l.dataVencimento,dataMovimento:l.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id});let T=d.idFinanceiroPlanoConta;d.tipo===1&&(V||{}).idFinanceiroPlanoContaCaixa&&(T=V.idFinanceiroPlanoContaCaixa);let P=await $db.financeiroPlanoConta.le({id:T}),k="";[3,4].includes(d.tipo)&&(k=(S=(m=(n=oa[0])==null?void 0:n.observacao)==null?void 0:m.match(/Autorização\s(\d+)/))==null?void 0:S[1],k&&(k=` (Autoriza\xE7\xE3o ${k})`)),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:la,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:P.id,idFinanceiroTitulo:l.idFinanceiroTitulo,dataEmissao:b,valorCredito:0,valorDebito:l.valor,descricao:String(P.descricao+k).trim(),observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:l.dataVencimento,dataMovimento:l.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id});for(const F of oa)F.idFinanceiroMovimentacaoAgrupamento===la&&(F.valorRealizado=F.valorARealizar,F.dataPagamento=l.dataVencimento,F.dataMovimento=l.dataVencimento,F.idDocumentoCaixaLiquidacao=V.id)}if(d.aliquota){const T=$utils.uuid(),P=$utils.arredondar(l.valor*(d.aliquota/100));if(oa.push({id:T,idFinanceiroPlanoConta:d.idFinanceiroPlanoContaAliquota,idContato:d.idContatoOperadoraCartao,dataEmissao:b,dataCompetencia:A,dataVencimento:l.dataVencimento,dataVencimentoOriginal:l.dataVencimento,valor:P,valorTotal:P,valorARealizar:P,valorMulta:0,percentualJuros:0,documentoId:i.id,documentoTipo:"Fatura",parcela:Ca+"/"+Ea,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${d.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${i.observacaoFaturamento||""} ${l.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:d.descricao,idDocumentoCaixa:V.id}),l.idFinanceiroTituloPagar=T,d.tipoFinanceiro==="T\xEDtulo Liquidado"){const k=$utils.uuid();L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:k,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:ja.id,dataEmissao:b,valorCredito:0,valorDebito:P,descricao:ja.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:l.dataVencimento,dataMovimento:l.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:T,idContato:d.idContatoOperadoraCartao,idDocumentoCaixa:V.id});let F=d.idFinanceiroPlanoConta;d.tipo===1&&(V||{}).idFinanceiroPlanoContaCaixa&&(F=V.idFinanceiroPlanoContaCaixa);let g=await $db.financeiroPlanoConta.le({id:F});L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:k,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:b,valorCredito:P,valorDebito:0,descricao:g.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:l.dataVencimento,dataMovimento:l.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:T,idContato:d.idContatoOperadoraCartao,idDocumentoCaixa:V.id});for(const _ of oa)_.id===T&&(_.idFinanceiroMovimentacaoAgrupamento=k,_.valorRealizado=P,_.dataPagamento=l.dataVencimento,_.dataMovimento=l.dataVencimento,_.idDocumentoCaixaLiquidacao=V.id)}}Ca++}}const Ga=[];for(const l of Da){const d=$utils.uuid(),T=$utils.uuid();for(const k of oa)k.id===l.idTitulo&&(k.idFinanceiroMovimentacaoAgrupamento=T,k.valorRealizado=k.valorARealizar,k.dataPagamento=b,k.dataMovimento=b,k.dataVencimento=b,k.dataVencimentoOriginal=b,k.idDocumentoCaixaLiquidacao=V.id);if(Ga.includes(l.idDocumentoCondicaoPagamento))continue;Ga.push(l.idDocumentoCondicaoPagamento);const P=$utils.arredondar(Da.reduce((k,F)=>F.idDocumentoCondicaoPagamento===l.idDocumentoCondicaoPagamento?k+(F.valor||0):k,0));oa.push({id:d,idFinanceiroPlanoConta:La.id,idContato:i.idContato,dataEmissao:b,dataCompetencia:A,dataVencimento:l.dataVencimento,dataVencimentoOriginal:l.dataVencimento,valor:P,valorTotal:P,valorARealizar:P,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:i.id,documentoTipo:"Fatura",idEmpresa:i.idEmpresa,formaDePagamento:l.formaPagamento.descricao,idDocumentoCaixa:V.id,cheque:1,idBanco:l.idBanco,agencia:l.agencia,conta:l.conta,numeroCheque:l.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${i.id} - C\xF3digoN #${T}`,descricao:"Cheque"}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:T,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:La.id,idFinanceiroTitulo:d,dataEmissao:b,valorCredito:0,valorDebito:P,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,idFinanceiroCheque:d,idDocumentoCaixa:V.id,documentoId:i.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:T,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:pa.id,idFinanceiroTitulo:d,dataEmissao:b,valorCredito:P,valorDebito:0,descricao:pa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,idFinanceiroCheque:d,idDocumentoCaixa:V.id,documentoId:i.id})}if(ra>0){const l=$utils.uuid();L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:pa.id,dataEmissao:b,valorCredito:ra,valorDebito:0,descricao:pa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,idDocumentoCaixa:V.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:ba.id,dataEmissao:b,valorCredito:0,valorDebito:ra,descricao:ba.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:"Renegocia\xE7\xE3o",documentoId:l,idDocumentoCaixa:V.id});for(const d of Qa)Ja.push({idFinanceiroMovimentacaoN:l,idFinanceiroTitulo:d.idTitulo,dataVencimento:b,valorOriginal:d.valor,valorDesconto:d.desconto,valorTotal:$utils.arredondar(d.valor-d.desconto)});for(const d of h){if(d.idFinanceiroMovimentacaoAgrupamento=l,d.idDocumentoCaixaLiquidacao=V.id,d.dataPagamento=b,d.dataMovimento=b,d.renegociado=1,d.cheque===1){d.valorRealizado=d.valor;continue}if(!d.valorARealizar){d.valorRealizado=d.valorTotal;continue}d.valorRealizado=d.valorARealizar}oa=oa.concat(h)}if(da===0){let l=$utils.uuid();const d=i.valorFrete||0;let T=0,P=0;const k=[];if(d>0&&(L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:b,valorCredito:0,valorDebito:d,descricao:aa.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Ha.id,dataEmissao:b,valorCredito:d,valorDebito:0,descricao:Ha.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id})),!r){l=$utils.uuid();for(const F of x){let g="",_={},M="",R={},ta="",va={};const ha=await $db.item.leNew({id:F.idItem});if(g=F.idPlanoContaEstoque,!g){const X=await $db.perfilContabilItem.le({idPerfilContabil:ha.idPerfilContabil,idCfop:F.idCfop,and:{idPerfilContabil:ha.idPerfilContabil,idCfop:F.idCfop}});X.length&&X[0].idPlanoContaEstoque&&(g=X[0].idPlanoContaEstoque)}if(!g&&Ua.id&&(g=Ua.id),!g&&F.idCfop&&(g=(await $db.cfop.le({id:F.idCfop})).idPlanoContaEstoque),_=await $db.financeiroPlanoConta.le({id:g}),!_.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(M="",!M){const X=await $db.perfilContabilItem.le({idPerfilContabil:ha.idPerfilContabil,idCfop:F.idCfop,and:{idPerfilContabil:ha.idPerfilContabil,idCfop:F.idCfop}});X.length&&X[0].idPlanoContaDespesa&&(M=X[0].idPlanoContaDespesa)}if(!M&&$a.id&&(M=$a.id),!M&&F.idCfop&&(M=(await $db.cfop.le({id:F.idCfop})).idPlanoContaDestino),R=await $db.financeiroPlanoConta.le({id:M}),!R.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const Va=$utils.arredondar(F.total-(F.descontoTotalRateado||0)-(F.descontoFaturaRateado||0)),Fa=$utils.arredondar(F.valorCustoMedio*F.quantidade);if(Fa){if(qa&&(F.operacaoFator<0?(L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:_.id,dataEmissao:F.dataHoraFinalizado||b,valorCredito:Fa,valorDebito:0,descricao:_.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${F.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:V.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:R.id,dataEmissao:F.dataHoraFinalizado||b,valorCredito:0,valorDebito:Fa,descricao:R.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${F.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:V.id})):(L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:_.id,dataEmissao:F.dataHoraFinalizado||b,valorCredito:0,valorDebito:Fa,descricao:_.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${F.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:V.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:R.id,dataEmissao:F.dataHoraFinalizado||b,valorCredito:Fa,valorDebito:0,descricao:R.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${F.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:V.id}))),ta=F.idPlanoContaDestino,!ta){const sa=await $db.perfilContabilItem.le({idPerfilContabil:ha.idPerfilContabil,idCfop:F.idCfop,and:{idPerfilContabil:ha.idPerfilContabil,idCfop:F.idCfop}});sa.length&&sa[0].idPlanoContaDespesa&&(ta=sa[0].idPlanoContaDespesa)}if(!ta&&$a.id&&(ta=$a.id),!ta&&F.idCfop&&(ta=(await $db.cfop.le({id:F.idCfop})).idPlanoContaDestino),va=await $db.financeiroPlanoConta.le({id:ta}),!va.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let X=!0;for(const sa of k)if(sa.idPlanoContaDestino===va.id&&sa.idPlanoContaEstoque===_.id){sa.valor=$utils.arredondar(sa.valor+Va),X=!1;break}X&&k.push({idPlanoContaDestino:va.id,idPlanoContaEstoque:_.id,valor:Va}),T+=Va}}for(const F of k)F.valor<0&&(P+=F.valor);for(const F of k)if(F.valor>0){const g=await $db.financeiroPlanoConta.le({id:F.idPlanoContaDestino}),_=$utils.arredondar(P*(F.valor/(T||1)));if(_>0){if(L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:b,valorCredito:0,valorDebito:_,descricao:aa.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:b,valorCredito:_,valorDebito:0,descricao:g.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:b,dataMovimento:b,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id}),qa)for(const M of Y)L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:b,valorCredito:0,valorDebito:$utils.arredondar((F.valor-_)*(M.valor/(ua||1))),descricao:aa.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:M.dataVencimento,dataMovimento:M.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:b,valorCredito:$utils.arredondar((F.valor-_)*(M.valor/(ua||1))),valorDebito:0,descricao:g.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:M.dataVencimento,dataMovimento:M.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id})}else if(qa)for(const M of Y){const R=$utils.arredondar(F.valor*(M.valor/(ua||1)));L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:b,valorCredito:0,valorDebito:R,descricao:aa.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:M.dataVencimento,dataMovimento:M.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id}),L.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:l,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:b,valorCredito:R,valorDebito:0,descricao:g.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:M.dataVencimento,dataMovimento:M.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:V.id})}}}}if(this.financeiroTitulo=oa,this.financeiroMovimentacao=L,this.financeiroRenegociacao=Ja,this.fatura=i,this.vendas=E,this.documentosEnvelope=y,this.carnes=h,!r){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let d,T,P,k;if(d=await $db.configuracoes.porNome("integracao.bten.business"),T=(B=(v=d[0])==null?void 0:v.valor)!=null?B:!1,d=await $db.configuracoes.porNome("integracao.bten.authorization"),P=(w=(O=d[0])==null?void 0:O.valor)!=null?w:!1,k=T&&P,k){const F=[],g=this.contatos[i.idContato],_=await $api.bten.send(g,i);for(let M=0;M<_.length;M++){const R=_[M];R.status?F.push(R.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${R.telefone}!`)}F.length&&this.$q.notifyPositive(`NPS enviado para ${F.join(",")}!`)}}catch(d){d.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${d.message}`),d.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",d)}let l;if(V!=null&&V.idCaixa){const d=await $erp().caixa.get(V==null?void 0:V.idCaixa);d!=null&&d.id&&(l=$db.caixa.tiposCaixa[Number(d.tipo)])}if([...E,...y].length&&~["SAT","NFCe"].indexOf(l))try{await this.$refs.documentosFiscais.emitirCupom(this.fatura.id)}catch{}if(this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"){$db.bonus.gera(i).then(P=>{P&&P!==!0&&$q.notifyPositive("B\xF4nus gerado com sucesso!")});const d=await $db.configuracoes.le({prefixoNome:"enviaemail.fatura"});let T=d.find(P=>P.idEmpresa===this.fatura.idEmpresa);T||(T=d.find(P=>!P.idEmpresa)),T&&await Po.enviar(this.fatura,T)}}return!0}catch(i){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",i)}finally{this.$q.loading.hide()}}};const qo={components:{DocumentoCodigo:fo,DocumentoMetas:po,DocumentosFiscais:bo,VendaCard:Fo,EnvelopeCard:$o,TituloCard:To,Faturamento:vo},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let r=!1;return r=this.fatura.status==="Aberta",r||(r=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!r},bonusSomenteLeitura(){return this.fatura.status!=="Aberta"}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0,totalBonus:0,tokenBonusUtilizado:""},vendas:[],vendasOriginal:[],documentosEnvelope:[],documentosEnvelopeOriginal:[],documentosItem:[],documentosItemOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],faturaTitulos:[],faturaMovimentacoes:[],livroDiario:{},erroCalculo:!1,erroCalculoMsg:"",erroCalculoBonusMsg:"",erroTokenBonusMsg:"",sistemaPai:"",impressaoVisivel:!1,configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,permissaoBonus:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[Do],methods:{async executarRecebimentoMultiplos(r){console.log(r)},async calcularPesoTotal(){var c,I;const r=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),e=[],u={};let D=0,a=0;for(const n of r){const m=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:n.id}});for(const S of m)e.push(S)}for(const n of e)if(n.operacaoFator===-1){if(n.idItem&&!u[n.idItem]){const m=await $erp().item.get(n.idItem);m&&(u[n.idItem]=m)}D+=(((c=u[n.idItem])==null?void 0:c.peso)||0)*(n.quantidade||0),a+=(((I=u[n.idItem])==null?void 0:I.pesoBruto)||0)*(n.quantidade||0)}D=$utils.arredondar(D,4),a=$utils.arredondar(a,4),this.pesoTotal=D?$filters.numeroZerosDireita(D,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,c,I;const r=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),e=[],u={};let D=0;for(const n of r){const m=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:n.id}});for(const S of m)e.push(S)}for(const n of e){if(n.operacaoFator!==-1||n.tipoItem!=="Produto")continue;if(n.idItem&&!u[n.idItem]){const v=await $erp().item.get(n.idItem);v&&(u[n.idItem]=v)}const m=((a=u[n.idItem])==null?void 0:a.altura)*((c=u[n.idItem])==null?void 0:c.largura)*((I=u[n.idItem])==null?void 0:I.comprimento)||0,S=n.quantidade||0;D+=m>0?m*S:0}D=$utils.arredondar(D,4),this.metroCubicoTotal=D?$filters.numeroZerosDireita(D,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...xo,async atualizar(){let r=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.permissaoBonus=await $db.permissao.objetoClienteSistema("configuracoes/bonus"),this.vendas=[],this.vendasOriginal=[],this.documentosEnvelope=[],this.documentosEnvelopeOriginal=[],this.documentosItem=[],this.documentosItemOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.erroCalculoBonusMsg="",this.erroTokenBonusMsg="",this.prop.id){const e=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(e.fatura),this.fatura=e.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(e.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=e.condicaoPagamento),this.vendasOriginal=$utils.clonar(e.vendas),this.vendas=e.vendas.sort((a,c)=>new Date(a.dataHoraFinalizado)<new Date(c.dataHoraFinalizado)?-1:1);const u=e.documentosEnvelope.sort((a,c)=>new Date(a.dataHoraFinalizado)<new Date(c.dataHoraFinalizado)?-1:1);if(this.documentosEnvelopeOriginal=$utils.clonar(u),this.documentosEnvelope=$utils.clonar(u),typeof this.receberTitulo.id!="object"&&this.receberTitulo.id&&!e.carnes.find(a=>a.id===this.receberTitulo.id)&&(e.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),r=!0),typeof this.receberTitulo.id=="object")for(let a of this.receberTitulo.id)a&&!e.carnes.find(c=>c.id===a)&&(e.carnes.push(await $db.financeiroTitulo.le({id:a})),r=!0);this.carnesOriginal=$utils.clonar(e.carnes),this.carnes=e.carnes.sort((a,c)=>new Date(a.dataVencimento)<new Date(c.dataVencimento)?-1:1);const D={};if(e.fatura.idContato){const a=e.fatura.idContato;D[a]||(D[a]=await $db.contato.le({id:a}))}this.configuraImpressaoCarne(e.fatura.idEmpresa),this.configuraImpressaoConvenio(e.fatura.idEmpresa),this.configuraImpressaoEnvelope(e.fatura.idEmpresa),this.configuraImpressaoFatura(e.fatura.idEmpresa),this.contatos=D,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal();try{r&&await this.salvarFatura()}catch(a){console.error(a)}}},async executar(r){if(r==="recalcular"){if(this.prop.id){const e=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(e.carnes),this.carnes=e.carnes,await this.calculaTotais()}}else r==="salvarFatura"?(await this.salvarFatura(),await this.atualizar(),this.$emit("executar","atualizarSemFechar")):(await this.atualizar(),this.$emit("executar",r))},async calculaTotais(r){const e=$utils.arredondar(this.vendas.reduce((a,c)=>a+c.totalDocumento||0,0)),u=$utils.arredondar(this.documentosEnvelope.reduce((a,c)=>a+c.totalDocumento||0,0)),D=$utils.arredondar(this.carnes.reduce((a,c)=>a+c.valorARealizar||0,0));if(r||(this.fatura.subTotal=$utils.arredondar(e+u+D),r="desconto"),r==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),r==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),await this.checarTokenBonus(),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)-(this.fatura.totalBonus||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.erroCalculoBonusMsg="",this.fatura.totalDesconto!==0){const a=e+u;a===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),a>0&&this.fatura.totalDesconto>a&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")}if(this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0),this.fatura.totalBonus!==0){const a=e+u;a===0&&(this.erroCalculoBonusMsg="B\xF4nus n\xE3o permitido para fatura sem venda"),a>0&&this.fatura.totalBonus>a&&(this.erroCalculoBonusMsg="B\xF4nus maior que o total das vendas")}this.fatura.totalBonus!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculoBonus="B\xF4nus com valor Inv\xE1lido");try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async checarTokenBonus(){var r,e,u,D,a,c,I;if(!(this.ultimoTokenBonusVerificado===this.fatura.tokenBonusUtilizado&&this.ultimoDescontoVerificado===this.fatura.totalDesconto&&this.ultimoPercentualDescontoVerificado===this.fatura.totalPercentualDesconto)){if(!this.fatura.tokenBonusUtilizado){this.fatura.totalBonus=0,this.erroTokenBonusMsg="";return}try{this.ultimoTokenBonusVerificado=this.fatura.tokenBonusUtilizado,this.ultimoDescontoVerificado=this.fatura.totalDesconto,this.ultimoPercentualDescontoVerificado=this.fatura.totalPercentualDesconto;const n=$utils.arredondar(this.vendas.reduce((B,O)=>B+O.totalDocumento||0,0)),m=$utils.arredondar(this.documentosEnvelope.reduce((B,O)=>B+O.totalDocumento||0,0)),S=n+m-(this.fatura.totalDesconto||0),v=await $utils.geeksApi({verificaBonus:{funcao:"1A130FC6-C9BA-4121-B9CF-069CEAEC36CB",tokenBonus:this.fatura.tokenBonusUtilizado,valorVenda:S,cnpjEmissor:this.fatura.numeroDocumentoEmpresa,cpfCliente:this.fatura.numeroDocumentoContato,idDocumentoDestino:this.fatura.id,utiliza:!1}});$utils.verificarErro(!["Ativo","Utilizado"].includes((e=(r=v.data)==null?void 0:r.verificaBonus)==null?void 0:e.status),"B\xF4nus inv\xE1lido"),$utils.verificarErro(!((D=(u=v.data)==null?void 0:u.verificaBonus)!=null&&D.valor),"Valor do B\xF4nus inv\xE1lido"),this.fatura.totalBonus=(I=(c=(a=v.data)==null?void 0:a.verificaBonus)==null?void 0:c.valor)!=null?I:0,this.erroTokenBonusMsg=""}catch(n){this.fatura.totalBonus=0,this.erroTokenBonusMsg=n.message}}},async configuraImpressaoConvenio(r){const e=await $db.configuracoes.porNome("impressao.convenio",r);this.configImpressaoConvenio=[...e.length?e.map(u=>({texto:"Imprimir Conv\xEAnio",...u})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(r){const e=await $db.configuracoes.porNome("impressao.carne",r);this.configImpressaoCarne=[...e.length?e.map(u=>({texto:"Imprimir Carn\xEA",...u})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(r){const e=await $db.configuracoes.porNome("impressao.envelope",r);this.configImpressaoEnvelope=[...e.length?e.map(u=>({texto:"Imprimir Envelope",...u})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(r){const e=await $db.configuracoes.porNome("impressao.fatura",r),u=[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"}];this.sistemaPai==="optisoul"&&u.push({valor:"termoGarantia",texto:"Termo de Garantia"}),this.configImpressaoFatura=[...e.length?e.map(D=>({texto:"Imprimir Fatura",...D})):u]},async reabrir(r){var e;if(!((e=this.fatura)!=null&&e.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!r)try{$q.loading.show(),await ho({idDocumento:this.fatura.id})}catch(u){this.$q.notifyError(u.message);return}finally{$q.loading.hide()}if(!r)try{await new Promise((u,D)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{u()}).onCancel(()=>{D()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const u=$utils.clonar(this.fatura),D=$utils.clonar(this.vendas),a=$utils.clonar(this.documentosEnvelope),c=$utils.clonar(this.documentosItem),I=this.$refs.faturamento.condicaoPagamento.filter(v=>v.valor);if(!r){const v=[];I.reduce((B,O)=>(O.idDocumentoCaixa&&!B[O.idDocumentoCaixa]&&(B[O.idDocumentoCaixa]=!0,v.push($db.hibrido.le({table:"documento",id:O.idDocumentoCaixa}))),B),{});for await(const B of v)if(B.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(v){$q.notifyError(v.message);return}let n=[],m=[],S=[];if(!r){n=await $db.financeiroTitulo.le({documentoId:u.id});for(const h of n)if(h.idFinanceiroBoleto){const p=await $erp().financeiroBoleto.get(h.idFinanceiroBoleto),s=await $db.financeiroBanco.le({id:p.idFinanceiroBanco}),x=await $db.banco.le({id:s.idBanco}),Z=p.revisao,b=x.baixa,A=x.registro;if(p.remessaOperacao!==b){const V=h.idFinanceiroBoleto,ga=$utils.uuid(),Y={id:ga,idFinanceiroBanco:p.idFinanceiroBanco,nossoNumero:p.nossoNumero,nossoNumeroDv:p.nossoNumeroDv,revisao:Z+1,idEmpresa:p.idEmpresa,idContato:p.idContato,empresaNome:p.empresaNome,empresaNumeroDocumento:p.empresaNumeroDocumento,contatoNome:p.contatoNome,contatoNumeroDocumento:p.contatoNumeroDocumento,contatoLogradouro:p.contatoLogradouro,contatoCEP:p.contatoCEP,contatoBairro:p.contatoBairro,contatoCidade:p.contatoCidade,contatoUF:p.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:p.dataVencimento,dataImpressao:p.dataImpressao,valor:p.valor,valorJuros:p.valorJuros,tipoJuros:p.tipoJuros,valorMulta:p.valorMulta,valorDesconto:p.valorDesconto,valorTotal:p.valorTotal,codigoBarras:p.codigoBarras,linhaDigitavel:p.linhaDigitavel,mensagem1:p.mensagem1,mensagem2:p.mensagem2,mensagem3:p.mensagem3,mensagem4:p.mensagem4,mensagem5:p.mensagem5,gerarRemessa:1,remessaOperacao:b};await $db.financeiroBoleto.grava({atual:Y});let ra=[];V&&(ra=await $db.financeiroTitulo.le({idFinanceiroBoleto:V}));for(const na of ra){const da=$utils.clonar(na);na.idFinanceiroBoleto=ga;let ca=[];V&&(ca=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:V}));for(const Pa of ca){const ba={id:$utils.uuid(),idFinanceiroBoleto:ga,idFinanceiroTitulo:Pa.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:ba})}await $db.financeiroTitulo.grava({atual:na,original:da})}if(p.remessaOperacao===A&&p.gerarRemessa===1)for(const na of[p,Y]){const da={...na,gerarRemessa:0};await $db.financeiroBoleto.grava({original:na,atual:da})}}}let v=[];this.$refs.faturamento.idDocumentoCaixa&&(v=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),n=await $db.financeiroTitulo.le({idFatura:u.id});let B=await $db.financeiroTitulo.le({idFatura:u.id});for(const h of $utils.clonar(n)){if(!h.idFinanceiroMovimentacaoAgrupamento)continue;const p=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:h.idFinanceiroMovimentacaoAgrupamento});for(const s of p){const x=await $db.financeiroTitulo.le({id:s.idFinanceiroTitulo});x.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(n=n.concat(x))}}let O=!1;for(const h of I){const p=await $db.financeiroTitulo.le({id:h.idFinanceiroTitulo});if(Object.keys(p).length){let s=[];s=v.filter(x=>x.idFinanceiroMovimentacaoN===p.idFinanceiroMovimentacaoAgrupamento),m=m.concat(s),s=v.filter(x=>x.idFinanceiroTitulo===p.id),m=m.concat(s),s=v.filter(x=>x.idFinanceiroCheque===p.id),m=m.concat(s),n=n.concat(p)}h.idFinanceiroTitulo="",h.sinal===1&&(O=!0)}B=await $db.financeiroTitulo.le({idFatura:u.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const h of B){if(!h.idFinanceiroMovimentacaoAgrupamento)continue;const p=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:h.idFinanceiroMovimentacaoAgrupamento});m=m.concat(p);const s=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:h.idFinanceiroMovimentacaoAgrupamento});S=S.concat(s)}if(B=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:u.id}),n=n.concat(B),u.id){let h=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:u.id});m=m.concat(h),h=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:u.id}),m=m.concat(h),h=await $db.financeiroMovimentacao.lerV2({documentoId:u.id});for(const p of h)(await $db.financeiroTitulo.le({id:p.idFinanceiroTitulo})).id||(m=m.concat(p))}const w=await $db.hibrido.lista({table:"documento",where:{idFatura:u.id}});for(const h of w){const p=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:h.id});m=m.concat(p)}let i=[];for(const h in n){const p=n[h].id;i.includes(p)?delete n[h]:i.push(p)}n=n.filter(h=>h),i=[];for(const h in m){const p=m[h].id;i.includes(p)?delete m[h]:i.push(p)}m=m.filter(h=>h),i=[];for(const h in S){const p=S[h].id;i.includes(p)?delete S[h]:i.push(p)}S=S.filter(h=>h);let E=$utils.dataAtual(),y=O?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:u.id,operacao:"Fatura",statusOriginal:u.status,statusFinalizado:y,dataHoraEmissao:E,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],u.status=y,y==="Aberta"&&(u.dataHoraFinalizado=""),y=O?"Aguardando Pagamento":"Aguardando Faturamento";for(const h of D)this.documentoStatus.push({id:$utils.uuid(),idDocumento:h.id,operacao:"Venda de Mercadoria",statusOriginal:h.status,statusFinalizado:y,dataHoraEmissao:E,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),h.status=y;for(const h of a)this.documentoStatus.push({id:$utils.uuid(),idDocumento:h.id,operacao:"Envelope",statusOriginal:h.status,statusFinalizado:h.status,dataHoraEmissao:E,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const h of c)h.status=y;this.fatura=u,this.vendas=D,this.documentosEnvelope=a,this.documentosItem=c}if(this.$q.loading.hide(),r&&await this.finalizar(r),this.$q.loading.show({message:"Processando..."}),r){let v=[],B=[],O=[],w=[],i=[],E=[];v=this.$refs.faturamento.condicaoPagamento.map(y=>y.id),B=this.$refs.faturamento.condicaoPagamentoOriginal.filter(y=>!v.includes(y.id));for(const y of B)if(y.idFinanceiroTitulo&&O.push(y.idFinanceiroTitulo),y.idFormaPagamento){let h;h=await $erp().formaPagamento.get(y.idFormaPagamento),(h||{}).aliquota&&(y.idFinanceiroTituloPagar?O.push(y.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const y of O){let h;if(h=await $erp().financeiroTitulo.get(y),h.id&&w.push(h),h.idFinanceiroMovimentacaoAgrupamento){let p,s;if(p=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:h.idFinanceiroMovimentacaoAgrupamento}}),s=(p.find(x=>x.idFinanceiroCheque)||{}).idFinanceiroCheque,s){let x=await $erp().financeiroTitulo.get(s);x.id&&w.push(x)}i.push(...p)}}for(let y of this.carnes){if(!y.id||(y=await $erp().financeiroTitulo.get(y.id),!(y||{}).idFinanceiroMovimentacaoAgrupamento))continue;let h,p;h=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:y.idFinanceiroMovimentacaoAgrupamento}}),p=await $db.hibrido.lista({table:"financeiroRenegociacao",where:{idFinanceiroMovimentacaoN:y.idFinanceiroMovimentacaoAgrupamento}}),i.push(...h),E.push(...p)}await $db.financeiroTitulo.remove(w),await $db.financeiroMovimentacao.remove(i),await $db.financeiroRenegociacao.remove(E)}else{await $db.financeiroTitulo.remove(n.filter(v=>!(v.carne&&v.idFatura===u.id))),await $db.financeiroMovimentacao.remove(m),await $db.financeiroRenegociacao.remove(S);for(const v of n.filter(B=>B.carne&&B.idFatura===u.id))await $db.financeiroTitulo.grava({original:v,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}return this.fatura.tokenBonusGerado&&!r&&($db.bonus.cancela(this.fatura),this.fatura.tokenBonusGerado=""),await this.salvarFatura(),await this.atualizar(),r?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let r,e,u,D;if(r=this.$refs.faturamento.condicaoPagamentoOriginal,e=this.$refs.faturamento.condicaoPagamento,D=$utils.arredondar(this.fatura.totalDocumento||0),u=$utils.arredondar(e.reduce((a,c)=>a+c.valor||0,0)),u!==D){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(r.length){let a=!1;e.length||(a=!0);for(const c of e)if(!r.find(I=>I.id===c.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,c)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{c()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){var r,e,u,D,a;try{this.$q.loading.show({message:"Processando..."});let c=$utils.clonar(((u=(e=(r=this==null?void 0:this.$refs)==null?void 0:r.faturamento)==null?void 0:e.condicaoPagamento)==null?void 0:u.filter(n=>n==null?void 0:n.valor))||{});for(let n in c)delete c[n].idDocumentoCondicaoPagamento,delete c[n].parcelas,delete c[n].formaPagamento,delete c[n].edicao,delete c[n].codigoDocumento,delete c[n].codigoDocumentoCaixa;const I=(this.carnesOriginal||[]).filter(n=>(this.financeiroTitulo||[]).find(m=>m.id===n.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,documentosEnvelope:this.documentosEnvelope,documentosEnvelopeOriginal:this.documentosEnvelopeOriginal,documentosItemOriginal:this.documentosItemOriginal,documentosItem:this.documentosItem,condicaoPagamentoOriginal:((a=(D=this.$refs)==null?void 0:D.faturamento)==null?void 0:a.condicaoPagamentoOriginal)||{},condicaoPagamento:c,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:I,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id&&typeof this.receberTitulo.id!="object"){let n=this.carnes.find(m=>m.id===this.receberTitulo.id);n.id&&await $db.financeiroTitulo.grava({original:n,atual:{idFatura:this.fatura.id}}),delete this.receberTitulo.id,await this.atualizar()}if(this.receberTitulo.id&&typeof this.receberTitulo.id=="object"){for(let n of this.receberTitulo.id){let m=this.carnes.find(S=>S.id===n);m.id&&await $db.financeiroTitulo.grava({original:m,atual:{idFatura:this.fatura.id}})}delete this.receberTitulo.id,await this.atualizar()}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async dialogImpressao(){if(this.carnes.length>0&&(this.fatura.status==="Finalizada"||this.fatura.status!=="Aguardando Pagamento"&&this.fatura.dataHoraFinalizado))return this.impressaoVisivel=!0,new Promise(r=>{this.resolveDialogImpressao=r})},async showContabilidade(){this.faturaTitulos=await $db.hibrido.lista({table:"financeiroTitulo",where:{documentoId:this.fatura.id}}),this.faturaMovimentacoes=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{documentoId:this.fatura.id}});const r={};for(const e of this.faturaMovimentacoes){const u=e.idFinanceiroMovimentacaoN||e.id;r[u]||(r[u]={data:e.dataCompetencia,agrupamento:e.codigoFinanceiroMovimentacaoN,automatico:e.automatico,debito:[],credito:[]}),e.valorCredito?r[u].credito.push(e):r[u].debito.push(e)}this.livroDiario=r},fecharDialogImpressao(){this.impressaoVisivel=!1,this.resolveDialogImpressao()},async reenviarBonus(r){try{$q.loading.show();const u=(await $utils.geeksApi({reenviaWhatsAppBonus:{funcao:"9F17EED5-57F2-4FFD-99B5-5D0C1757DFB7",idFatura:r}})).data.reenviaWhatsAppBonus;u.mensagem.includes("Falha ao enviar mensagem")?$q.notifyError(u.mensagem):$q.notifyPositive(u.mensagem),console.log("REENVIAR BONUS RESP: ",u.mensagem)}catch(e){$q.notifyError("Erro ao reenviar b\xF4nus pelo WhatsApp.",e)}finally{$q.loading.hide()}}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},_o={id:"Fatura",class:"bg-white rounded-borders"},Vo={class:"bg-grey-2 rounded-borders q-px-xs q-pb-lg"},ko={class:"bg-grey-2 bordered-radius q-px-xs q-py-md q-mb-md"},Mo={class:"q-pa-sm",style:{"margin-top":"-16px"}},Io={class:"q-pa-sm",style:{"margin-top":"-16px"}};function zo(r,e,u,D,a,c){const I=U("avatar"),n=U("g-col"),m=U("g-label"),S=U("DocumentoCodigo"),v=U("g-row"),B=U("DocumentoMetas"),O=U("VendaCard"),w=U("EnvelopeCard"),i=U("TituloCard"),E=U("campo"),y=U("Faturamento"),h=U("DocumentosFiscais"),p=U("nomeValor");return f(),j("div",_o,[o(v,{gutter:"sm",items:"center"},{default:t(()=>[o(n,{order:"1 sm0",col:"shrink"},{default:t(()=>[o(I,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"50"},null,8,["imagem","rotulo"])]),_:1}),o(n,{order:"2 sm1"},{default:t(()=>[o(m,{text:"sub1 medium",lines:"2"},{default:t(()=>[$(z(a.fatura.descricaoContato),1)]),_:1})]),_:1}),o(n,{order:"0 sm3",col:"12 sm-shrink"},{default:t(()=>[o(v,{items:"center",justify:"end"},{default:t(()=>[a.fatura.id?(f(),C(S,{key:0,documento:a.fatura,class:"q-mr-xs"},null,8,["documento"])):q("",!0),a.fatura.status==="Finalizada"||a.fatura.status!=="Aguardando Pagamento"&&a.fatura.dataHoraFinalizado?(f(),C(W,{key:1,icon:"print",size:"md",color:"primary",round:"",flat:""},{default:t(()=>[o(Ma,null,{default:t(()=>[ea((f(),C(fa,{link:"",separator:""},{default:t(()=>[(f(!0),j(H,null,J(a.configImpressaoFatura,s=>(f(),C(K,{clickable:"",key:s.valor,onClick:x=>r.$imprimir(s.valor,(a.fatura||{}).id||"0")},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"print"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>[$(z(s.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(f(!0),j(H,{key:0},J(a.configImpressaoEnvelope,s=>(f(),C(K,{clickable:"",key:s.valor,onClick:x=>r.$imprimir(s.valor,(a.fatura||{}).id||"0")},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"print"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>[$(z(s.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):q("",!0),(f(!0),j(H,null,J(a.configImpressaoCarne,s=>(f(),C(K,{clickable:"",key:s.valor,onClick:x=>r.$imprimir(s.valor,(a.fatura||{}).id||"0")},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"print"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>[$(z(s.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(f(!0),j(H,null,J(a.configImpressaoConvenio,s=>(f(),C(K,{clickable:"",key:s.valor,onClick:x=>r.$imprimir(s.valor,(a.fatura||{}).id||"0")},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"print"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>[$(z(s.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[ia]])]),_:1})]),_:1})):q("",!0),o(W,{icon:"more_vert",size:"md",color:"tertiary",flat:"",round:""},{default:t(()=>[o(Ma,null,{default:t(()=>[o(fa,{link:"",separator:""},{default:t(()=>{var s;return[a.fatura.id&&!!((s=a.fatura)!=null&&s.tokenBonusGerado)?ea((f(),C(K,{key:0,onClick:e[0]||(e[0]=x=>c.reenviarBonus(a.fatura.id)),clickable:""},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"card_giftcard"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>e[13]||(e[13]=[$("Reenviar o B\xF4nus")])),_:1})]),_:1})]),_:1})),[[ia]]):q("",!0),a.fatura.id?ea((f(),C(K,{key:1,clickable:"",onClick:e[1]||(e[1]=x=>r.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"account_balance"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>e[14]||(e[14]=[$("Emitir cupom")])),_:1})]),_:1})]),_:1})),[[ia]]):q("",!0),a.fatura.id&&r.$utils.mapearStatus(a.fatura).permiteNota?(f(),j(H,{key:2},[ea((f(),C(K,{onClick:e[2]||(e[2]=x=>r.emitirNFeV2({idFatura:a.fatura.id},1,"Venda")),clickable:""},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"account_balance"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>e[15]||(e[15]=[$("NFe de Sa\xEDda/Venda")])),_:1})]),_:1})]),_:1})),[[ia]]),ea((f(),C(K,{onClick:e[3]||(e[3]=x=>r.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o")),clickable:""},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"account_balance"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>e[16]||(e[16]=[$("NFe de Entrada/Devolu\xE7\xE3o")])),_:1})]),_:1})]),_:1})),[[ia]]),ea((f(),C(K,{onClick:e[4]||(e[4]=x=>r.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa")),clickable:""},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"account_balance"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>e[17]||(e[17]=[$("NFe de Remessa")])),_:1})]),_:1})]),_:1})),[[ia]])],64)):q("",!0),a.fatura.id?ea((f(),C(K,{key:3,clickable:"",onClick:e[5]||(e[5]=x=>r.$db.log.show({documentoTipo:"Fatura",documentoId:a.fatura.id}))},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"description"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>e[18]||(e[18]=[$("Ver Log")])),_:1})]),_:1})]),_:1})),[[ia]]):q("",!0)]}),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),o(v,{gutter:"sm"},{default:t(()=>[o(n,{col:"12"},{default:t(()=>[o(B,{ref:"documentoMetas"},null,512)]),_:1})]),_:1}),o(v,{gutter:"sm"},{default:t(()=>[o(n,{col:"12"},{default:t(()=>[wa("div",Vo,[a.vendas.length?(f(),C(v,{key:0},{default:t(()=>[o(n,{col:"12"},{default:t(()=>[o(m,{icon:"shopping_cart sm tertiary left",text:"sub2 medium",class:"q-mt-lg"},{default:t(()=>e[19]||(e[19]=[$(" Vendas ")])),_:1}),o(ya)]),_:1}),(f(!0),j(H,null,J(a.vendas,s=>(f(),C(n,{key:s.id,col:"12"},{default:t(()=>[o(O,{id:s.id,onAtualizar:c.atualizar,onExecutar:c.executar},null,8,["id","onAtualizar","onExecutar"])]),_:2},1024))),128))]),_:1})):q("",!0),a.documentosEnvelope.length?(f(),C(v,{key:1},{default:t(()=>[o(n,{col:"12"},{default:t(()=>[o(m,{icon:"mdi-glasses sm tertiary left",text:"sub2 medium",class:"q-mt-lg"},{default:t(()=>e[20]||(e[20]=[$(" Envelopes ")])),_:1}),o(ya)]),_:1}),(f(!0),j(H,null,J(a.documentosEnvelope,s=>(f(),C(n,{key:s.id,col:"12"},{default:t(()=>[o(w,{id:s.id,onExecutar:c.executar},null,8,["id","onExecutar"])]),_:2},1024))),128))]),_:1})):q("",!0),a.carnes.length?(f(),C(v,{key:2},{default:t(()=>[o(n,{col:"12"},{default:t(()=>[o(m,{icon:"mdi-file-document sm tertiary left",text:"sub2 medium",class:"q-mt-lg"},{default:t(()=>e[21]||(e[21]=[$(" Titulos (Carn\xEAs/Boletos) ")])),_:1}),o(ya)]),_:1}),(f(!0),j(H,null,J(a.carnes,s=>(f(),C(n,{key:s.id,col:"12"},{default:t(()=>[o(i,{onExecutar:c.executar,dados:s},null,8,["onExecutar","dados"])]),_:2},1024))),128))]),_:1})):q("",!0)])]),_:1})]),_:1}),o(v,{gutter:"sm",items:"center",justify:"end"},{default:t(()=>[o(n,{col:"12 md6"},{default:t(()=>[o(v,{items:"center"},{default:t(()=>[o(n,{col:"4 lg3"},{default:t(()=>[o(m,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[22]||(e[22]=[$("Subtotal")])),_:1})]),_:1}),o(n,null,{default:t(()=>[o(m,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[$(z(r.$filters.numero(a.fatura.subTotal,2)),1)]),_:1})]),_:1})]),_:1}),a.permissaoDesconto?(f(),C(v,{key:0,items:"center"},{default:t(()=>[o(n,{col:"4"},{default:t(()=>[o(m,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[23]||(e[23]=[$("Desconto")])),_:1})]),_:1}),o(n,{col:"4"},{default:t(()=>[o(E,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[e[6]||(e[6]=s=>a.fatura.totalPercentualDesconto=s),e[7]||(e[7]=s=>c.calculaTotais("descontoPercentual"))],error:a.erroCalculo,debounce:500,decimals:"2",suffix:"%","somente-leitura":c.descontoSomenteLeitura,ocultarAjuda:"",tipo:"decimal"},null,8,["modelValue","error","somente-leitura"])]),_:1}),o(n,{col:"4"},{default:t(()=>[o(E,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[e[8]||(e[8]=s=>a.fatura.totalDesconto=s),e[9]||(e[9]=s=>c.calculaTotais("desconto"))],error:a.erroCalculo,errorMessage:a.erroCalculoMsg,"somente-leitura":c.descontoSomenteLeitura,debounce:500,ocultarAjuda:"",tipo:"decimal",decimals:"2"},null,8,["modelValue","error","errorMessage","somente-leitura"])]),_:1})]),_:1})):q("",!0),a.permissaoBonus?(f(),C(v,{key:1,items:"center"},{default:t(()=>[o(n,{col:"4"},{default:t(()=>[o(m,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[24]||(e[24]=[$("B\xF4nus")])),_:1})]),_:1}),o(n,{col:"4"},{default:t(()=>[o(E,{modelValue:a.fatura.tokenBonusUtilizado,"onUpdate:modelValue":[e[10]||(e[10]=s=>a.fatura.tokenBonusUtilizado=s),e[11]||(e[11]=s=>c.calculaTotais("bonus"))],"somente-leitura":c.bonusSomenteLeitura,error:!!a.erroTokenBonusMsg,debounce:500,errorMessage:a.erroTokenBonusMsg,ocultarAjuda:"","rotulo-fixo":"Token do B\xF4nus",mask:"NNNN-NNNN"},null,8,["modelValue","somente-leitura","error","errorMessage"])]),_:1}),o(n,{col:"4"},{default:t(()=>[o(m,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[$(z(r.$filters.numero(a.fatura.totalBonus,2)),1)]),_:1})]),_:1})]),_:1})):q("",!0),o(v,{items:"center"},{default:t(()=>[o(n,{col:"4 lg3"},{default:t(()=>[o(m,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[25]||(e[25]=[$("Total")])),_:1})]),_:1}),o(n,null,{default:t(()=>[o(m,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[$(z(r.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1})]),_:1})]),_:1}),a.pesoTotal?(f(),C(v,{key:2,items:"center"},{default:t(()=>[o(n,{col:"4 lg3"},{default:t(()=>[o(m,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[26]||(e[26]=[$("Peso Total")])),_:1})]),_:1}),o(n,null,{default:t(()=>[o(m,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[$(" 1,2 "+z(a.pesoTotal),1)]),_:1})]),_:1})]),_:1})):q("",!0),a.pesoBrutoTotal?(f(),C(v,{key:3,items:"center"},{default:t(()=>[o(n,{col:"4 lg3"},{default:t(()=>[o(m,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[27]||(e[27]=[$("Peso Bruto Total")])),_:1})]),_:1}),o(n,null,{default:t(()=>[o(m,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[$(" 3231,0 "+z(a.pesoBrutoTotal),1)]),_:1})]),_:1})]),_:1})):q("",!0),a.metroCubicoTotal?(f(),C(v,{key:4,items:"center"},{default:t(()=>[o(n,{col:"4 lg3"},{default:t(()=>[o(m,{style:{"line-height":"40px"},bordered:"bottom"},{default:t(()=>e[28]||(e[28]=[$("Metro C\xFAbico Total")])),_:1})]),_:1}),o(n,null,{default:t(()=>[o(m,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[$(" 3412,08 "+z(a.metroCubicoTotal),1)]),_:1})]),_:1})]),_:1})):q("",!0)]),_:1})]),_:1}),o(y,{onExecutar:c.executar,onSalvarFatura:c.salvarFatura,documento:a.fatura,ref:"faturamento",class:"q-my-md"},null,8,["onExecutar","onSalvarFatura","documento"]),o(v,{gutter:"sm",items:"center"},{default:t(()=>[o(n,{col:"12"},{default:t(()=>[wa("div",ko,[o(h,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])]),_:1})]),_:1}),r.$db.usuario.desenvolvedor()?(f(),C(v,{key:0,gutter:"sm"},{default:t(()=>[o(n,{col:"12"},{default:t(()=>[o(ka,{onShow:c.showContabilidade,"expand-separator":"",dense:"","expand-icon-class":"q-px-sm","header-class":"q-pa-sm border-bottom",class:"bg-amber-2 border-full bordered-radius"},{header:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"credit_card",size:"sm"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>e[29]||(e[29]=[$("Contabilidade")])),_:1}),o(G,{caption:""},{default:t(()=>e[30]||(e[30]=[$("Apenas desenvolvedores")])),_:1})]),_:1})]),default:t(()=>[a.faturaTitulos.length?(f(),C(fa,{key:0,class:"q-pa-xs"},{default:t(()=>[o(m,{icon:"list sm tertiary left",text:"sub2 medium"},{default:t(()=>e[31]||(e[31]=[$("Titulos")])),_:1}),(f(!0),j(H,null,J(a.faturaTitulos,s=>(f(),C(ka,{key:s.id,dense:"","hide-expand-icon":"","expand-separator":"","header-class":"q-pa-none border-bottom",class:"border-full"},{header:t(()=>[o(v,{gutter:"xs-x",width:"100%",class:"cursor-pointer"},{default:t(()=>[o(n,{col:"6 sm3 md2"},{default:t(()=>[o(E,{modelValue:s.dataVencimento,dense:"",borderless:"","somente-leitura":"",rotulo:"Data vencimento",tipo:"data"},null,8,["modelValue"])]),_:2},1024),o(n,{col:"6 sm3 md2"},{default:t(()=>[o(E,{modelValue:s.dataPagamento||"A pagar",tipo:s.dataPagamento?"data":"texto",dense:"",borderless:"","somente-leitura":"",rotulo:"Data pagamento"},null,8,["modelValue","tipo"])]),_:2},1024),o(n,{col:"6 sm3 md2"},{default:t(()=>[o(E,{modelValue:s.parcela,"somente-leitura":"",borderless:"",align:"left",rotulo:"Parcela"},null,8,["modelValue"])]),_:2},1024),o(n,{col:"6 sm6 md2"},{default:t(()=>[o(E,{modelValue:s.valor,"somente-leitura":"",borderless:"",align:"left",rotulo:"Valor",decimals:"2",tipo:"decimal"},null,8,["modelValue"])]),_:2},1024),o(n,{col:"12 sm6 md2"},{default:t(()=>[o(E,{modelValue:s.formaDePagamento,borderless:"","somente-leitura":"",rotulo:"Forma de pagamento"},null,8,["modelValue"])]),_:2},1024),o(n,{col:"12 sm12 md2"},{default:t(()=>[o(E,{modelValue:s.observacao,borderless:"","somente-leitura":"",rotulo:"Observa\xE7\xE3o"},null,8,["modelValue"])]),_:2},1024)]),_:2},1024)]),default:t(()=>[wa("div",Mo,[(f(!0),j(H,null,J(s,(x,Z)=>(f(),C(m,{key:Z,inline:""},{default:t(()=>[o(p,{nome:Z,valor:String(x)},null,8,["nome","valor"])]),_:2},1024))),128))])]),_:2},1024))),128))]),_:1})):q("",!0),a.faturaMovimentacoes.length?(f(),C(fa,{key:1,class:"q-pa-xs q-pt-lg"},{default:t(()=>[o(m,{icon:"list sm tertiary left",text:"sub2 medium"},{default:t(()=>e[32]||(e[32]=[$("Movimenta\xE7\xF4es")])),_:1}),(f(!0),j(H,null,J(a.faturaMovimentacoes,s=>(f(),C(ka,{key:s.id,dense:"","hide-expand-icon":"","expand-separator":"","header-class":"q-pa-none border-bottom",class:"border-full"},{header:t(()=>[o(v,{gutter:"xs-x",width:"100%",class:"cursor-pointer"},{default:t(()=>[o(n,{col:"6 sm12 md-grow"},{default:t(()=>[o(E,{modelValue:s.descricao,ocultarAjuda:"","somente-leitura":"",borderless:"",rotulo:"Descri\xE7\xE3o"},null,8,["modelValue"])]),_:2},1024),o(n,{col:"6 sm md2"},{default:t(()=>[o(E,{modelValue:s.dataCompetencia,"somente-leitura":"",borderless:"",ocultarAjuda:"",dense:"",rotulo:"Data competencia",tipo:"data"},null,8,["modelValue"])]),_:2},1024),s.valorCredito?(f(),C(n,{key:0,col:"xs sm md2"},{default:t(()=>[o(E,{modelValue:s.valorCredito,"somente-leitura":"",borderless:"",ocultarAjuda:"",align:"left",rotulo:"Valor Credito",decimals:"2",tipo:"decimal"},null,8,["modelValue"])]),_:2},1024)):q("",!0),s.valorDebito?(f(),C(n,{key:1,col:"xs sm md2"},{default:t(()=>[o(E,{modelValue:s.valorDebito,"somente-leitura":"",borderless:"",ocultarAjuda:"",align:"left",rotulo:"Valor Debito",decimals:"2",tipo:"decimal"},null,8,["modelValue"])]),_:2},1024)):q("",!0),o(n,{col:"12 md-grow"},{default:t(()=>[o(E,{modelValue:s.observacao,ocultarAjuda:"",borderless:"","somente-leitura":"",rotulo:"Observa\xE7\xE3o"},null,8,["modelValue"])]),_:2},1024)]),_:2},1024)]),default:t(()=>[wa("div",Io,[(f(!0),j(H,null,J(s,(x,Z)=>(f(),C(m,{key:Z,inline:""},{default:t(()=>[o(p,{nome:Z,valor:String(x)},null,8,["nome","valor"])]),_:2},1024))),128))])]),_:2},1024))),128))]),_:1})):q("",!0),Object.keys(a.livroDiario).length?(f(),C(fa,{key:2,class:"q-pa-xs q-pt-lg"},{default:t(()=>[o(m,{icon:"list sm tertiary left",text:"sub2 medium"},{default:t(()=>e[33]||(e[33]=[$("Livro Di\xE1rio - Movimenta\xE7\xE3oN")])),_:1}),(f(!0),j(H,null,J(a.livroDiario,s=>(f(),j("div",{key:s.id,class:"border-full rounded-borders"},[o(v,{class:"q-pl-md q-pt-md"},{default:t(()=>[o(p,{nome:"Data",valor:r.$filters.data(s.data)},null,8,["valor"]),o(p,{nome:"Hora",valor:r.$filters.hora(s.data)},null,8,["valor"]),o(p,{nome:"Autom\xE1tico",valor:s.automatico?"Sim":"N\xE3o"},null,8,["valor"]),o(p,{nome:"C\xF3digo agrupamento",valor:s.agrupamento},null,8,["valor"])]),_:2},1024),s.debito.length?(f(),C(v,{key:0,class:"q-pl-lg q-py-xs"},{default:t(()=>[(f(!0),j(H,null,J(s.debito,x=>(f(),j("div",{key:x.id},[o(p,{nome:"Debito",valor:x.descricao},null,8,["valor"]),o(p,{nome:"Valor",valor:x.valorDebito},null,8,["valor"]),o(p,{nome:"Observa\xE7\xE3o",valor:x.Observa\u00E7\u00E3oervacao},null,8,["valor"])]))),128))]),_:2},1024)):q("",!0),s.credito.length?(f(),C(v,{key:1,class:"q-pl-lg q-py-xs"},{default:t(()=>[(f(!0),j(H,null,J(s.credito,x=>(f(),j("div",{key:x.id},[o(p,{nome:"Credito",valor:x.descricao},null,8,["valor"]),o(p,{nome:"Valor",valor:x.valorCredito},null,8,["valor"]),o(p,{nome:"Observa\xE7\xE3o",valor:x.observacao},null,8,["valor"])]))),128))]),_:2},1024)):q("",!0)]))),128))]),_:1})):q("",!0)]),_:1},8,["onShow"])]),_:1})]),_:1})):q("",!0),o(Sa,{modelValue:a.impressaoVisivel,"onUpdate:modelValue":e[12]||(e[12]=s=>a.impressaoVisivel=s),onKeyup:Ra(c.fecharDialogImpressao,["esc"]),persistent:""},{default:t(()=>[o(za,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"350px","max-width":"400px"}},{default:t(()=>[o(Ba,null,{default:t(()=>[o(Ta,null,{default:t(()=>[o(W,{icon:"arrow_back",flat:"",round:"",dense:"",onClick:c.fecharDialogImpressao},null,8,["onClick"]),o(Na,null,{default:t(()=>e[34]||(e[34]=[$("Imprimir")])),_:1})]),_:1})]),_:1}),o(Aa,null,{default:t(()=>[o(Oa,null,{default:t(()=>[o(fa,{link:"",separator:""},{default:t(()=>[(f(!0),j(H,null,J(a.configImpressaoFatura,s=>(f(),C(K,{clickable:"",key:s.valor,onClick:x=>r.$imprimir(s.valor,(a.fatura||{}).id||"0")},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"print"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>[$(z(s.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(f(!0),j(H,{key:0},J(a.configImpressaoEnvelope,s=>(f(),C(K,{clickable:"",key:s.valor,onClick:x=>r.$imprimir(s.valor,(a.fatura||{}).id||"0")},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"print"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>[$(z(s.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):q("",!0),(f(!0),j(H,null,J(a.configImpressaoCarne,s=>(f(),C(K,{clickable:"",key:s.valor,onClick:x=>r.$imprimir(s.valor,(a.fatura||{}).id||"0")},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"print"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>[$(z(s.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(f(!0),j(H,null,J(a.configImpressaoConvenio,s=>(f(),C(K,{clickable:"",key:s.valor,onClick:x=>r.$imprimir(s.valor,(a.fatura||{}).id||"0")},{default:t(()=>[o(N,{avatar:""},{default:t(()=>[o(Q,{name:"print"})]),_:1}),o(N,null,{default:t(()=>[o(G,null,{default:t(()=>[$(z(s.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])])}var Bo=Ia(qo,[["render",zo]]);const No={components:{CpfCnpjNoCupom:Co,Fatura:Bo},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let r;try{r=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let e=await $db.hibrido.le({table:"documento",id:this.id});this.fatura=e,await this.verificarPermissoes(),this.desativarBotoes(),e.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),e.status==="Finalizada"||e.status!=="Aguardando Pagamento"&&e.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(e.idContato,$q.notify)}finally{clearTimeout(r),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(r){r.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizar(r){const u={cpfCnpjNoCupom:this.cpfCnpjNoCupom};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(!1,u)){this.lockEsc=!1;return}await this.$refs.fatura.atualizar(),await this.atualizar(),await this.$refs.fatura.dialogImpressao(),this.$emit("executar","finalizar"),this.fechar()},async executar(r){switch(r){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}if(r==="atualizarSemFechar"){await this.atualizar(),this.runOnHide.push(()=>this.$emit("executar","atualizar")),await this.$forceUpdate();return}this.$emit("executar",r),this.fechar()},fechar(){this.visivel=!1},async executarRecebimentoMultiplos(r){return await this.$refs.fatura.executarRecebimentoMultiplos(r)},async mostrar(r={}){this.id=r.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(r=>r()),this.runOnHide=[]},async salvar(){try{await new Promise((r,e)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{r()}).onCancel(()=>{e()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria")}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}},Ao={id:"FaturaModal"};function Oo(r,e,u,D,a,c){const I=U("Fatura"),n=U("CpfCnpjNoCupom");return f(),j("div",Ao,[o(Sa,{modelValue:a.visivel,"onUpdate:modelValue":e[0]||(e[0]=m=>a.visivel=m),onKeyup:Ra(c.voltar,["esc"]),onHide:c.onHide,maximized:"",persistent:""},{default:t(()=>[o(za,{container:"",view:"hHh LpR fFf",class:"bg-grey-3"},{default:t(()=>[o(Ba,null,{default:t(()=>[o(Ta,null,{default:t(()=>[ea(o(W,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[ia]]),o(Na,null,{default:t(()=>e[3]||(e[3]=[$("Fatura")])),_:1}),a.visibilidade.botao.salvar?(f(),C(W,{key:0,onClick:c.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):q("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(f(),C(W,{key:1,onClick:c.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):q("",!0)]),_:1})]),_:1}),o(Aa,null,{default:t(()=>[o(Oa,{class:"u-container q-py-md"},{default:t(()=>[a.fatura.id?(f(),C(I,{key:0,onExecutar:c.executar,ref:"fatura",prop:{id:a.fatura.id},receberTitulo:u.receberTitulo},null,8,["onExecutar","prop","receberTitulo"])):q("",!0)]),_:1})]),_:1}),o(Ka,{class:"bg-white",bordered:""},{default:t(()=>[o(Ta,{class:"q-pa-sm u-container"},{default:t(()=>[o(go),a.visibilidade.botao.reabrir?(f(),C(W,{key:0,onClick:c.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):q("",!0),a.visibilidade.botao.reabrir?ea((f(),C(W,{key:1,label:"Fechar",color:"tertiary",flat:"",class:"q-ml-sm"},null,512)),[[ia]]):q("",!0),a.visibilidade.botao.reabrir?q("",!0):(f(),C(W,{key:2,onClick:c.finalizar,disabled:!a.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),o(n,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":e[1]||(e[1]=m=>a.cpfCnpjNoCupom.visivel=m),onConfirmar:e[2]||(e[2]=m=>c.finalizar()),dados:a.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var Ho=Ia(No,[["render",Oo]]);export{Ho as F,To as T};
