import{_ as k,a as $,r as b,o as d,d as h,w as r,H as y,f as a,Q as p,N as F,C as v,ee as T,be as L,p as _,h as x,i as C,k as g,t as w,e as E,du as D,bf as S,P as I,S as V,T as N,j as B,U as q,F as j,x as U,G as M,J as A,I as z,M as R,v as O,K as P,aU as Q,D as W}from"./index.67592aac.js";import{o as H}from"./open-url.7e918f17.js";import{V as J}from"./Visualizador.2a529932.js";const X={data(){return{email:{de:"",para:"",assunto:"",mensagem:""},ruleObrigatorio:e=>(e||"").trim().length||"Preenchimento obrigat\xF3rio"}},methods:{async enviarNFeEmail(e){const{showLoading:o,successMsg:i,errorMsg:s}=e!=null?e:{};try{(o==null||o)&&$q.loading.show({message:"Envio de e-mail em andamento...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const t=[{name:`danfe_${this.nota.nNF}.pdf`,content:this.html,method:"html2pdf"}];for(const m of this.xmls)t.push({name:`${m.tipo}_${m.nNF}_${m.operacao}${m.nSeqEvento>1?"_"+m.nSeqEvento:""}.xml`,content:m.xmlProt});const n={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"drab azmd uvtf izhd"},from:this.email.de,to:this.email.para,subject:this.email.assunto,text:this.email.mensagem,attachments:t},l=await $({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:n});this.$q.notifyPositive((l==null?void 0:l.status)===200&&i?i:l.data.message)}catch(t){this.$q.notifyError(s||"Erro ao enviar e-mail",t)}finally{this.$q.loading.hide()}},async enviarNFeEmailAutomatico(e,o){var i,s,t,n,l,m,u;try{if(this.html=o,this.nota=await $db.hibrido.le({table:"documentoFiscalEletronico",id:e}),this.xmls=await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:e}}),this.json=JSON.parse((i=this.nota.json)!=null?i:null),!((n=(t=(s=this.json)==null?void 0:s.infNFe)==null?void 0:t.dest)!=null&&n.email)){this.$q.notify({type:"warning",message:"Cliente sem e-mail cadastrado. XML e DANFE n\xE3o enviado automaticamente."});return}this.email={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:(u=(m=(l=this.json)==null?void 0:l.infNFe)==null?void 0:m.dest)==null?void 0:u.email,assunto:`Nota Fiscal Eletr\xF4nica N\xBA ${this.nota.nNF}`,mensagem:`Voc\xEA est\xE1 recebendo os arquivos digitais NFe (Nota Fiscal Eletr\xF4nica) da empresa ${this.nota.xFantEmitente}`},this.enviarNFeEmail({successMsg:`XML e DANFE enviados para ${this.email.para} com sucesso.`,errorMsg:"Erro ao enviar e-mail. XML e DANFE n\xE3o enviado automaticamente."})}catch(c){this.$q.notifyError("Erro ao abrir a nota",c)}},async abrirNFeEmail(e,o){try{this.html=o,this.nota=await $db.hibrido.le({table:"documentoFiscalEletronico",id:e}),this.xmls=await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:e}}),this.json=JSON.parse(this.nota.json),this.email={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:this.$lodash.get(this.json,"infNFe.dest.email",""),assunto:`Nota Fiscal Eletr\xF4nica N\xBA ${this.nota.nNF}`,mensagem:`Voc\xEA est\xE1 recebendo os arquivos digitais NFe (Nota Fiscal Eletr\xF4nica) da empresa ${this.nota.xFantEmitente}`},this.$refs.dialogNFeEmail.show()}catch(i){this.$q.notifyError("Erro ao abrir a nota",i)}}},mounted(){$utils.emitter.off("abrirNFeEmail"),$utils.emitter.on("abrirNFeEmail",this.abrirNFeEmail),$utils.emitter.off("enviarNFeEmailAutomatico"),$utils.emitter.on("enviarNFeEmailAutomatico",this.enviarNFeEmailAutomatico)},beforeUnmount(){$utils.emitter.off("enviarNFeEmailAutomatico"),$utils.emitter.off("abrirNFeEmail")}};function G(e,o,i,s,t,n){const l=b("campo"),m=b("row"),u=b("card"),c=b("dialogForm");return d(),h(c,{onSubmit:n.enviarNFeEmail,ref:"dialogNFeEmail",footer:"",title:"Nota Fiscal / Email",size:"md"},{buttonsFooter:r(()=>[y(a(p,{label:"Cancelar",color:"tertiary",flat:""},null,512),[[F]]),a(p,{label:"Enviar",type:"submit",color:"primary"})]),default:r(()=>[a(u,null,{default:r(()=>[a(m,{class:"q-col-gutter-y-md"},{default:r(()=>[a(l,{modelValue:t.email.de,"onUpdate:modelValue":o[0]||(o[0]=f=>t.email.de=f),"somente-leitura":"",filled:"",col:"12",rotulo:"De"},null,8,["modelValue"]),a(l,{modelValue:t.email.para,"onUpdate:modelValue":o[1]||(o[1]=f=>t.email.para=f),rules:[t.ruleObrigatorio],filled:"",col:"12",rotulo:"Para"},null,8,["modelValue","rules"]),a(l,{modelValue:t.email.assunto,"onUpdate:modelValue":o[2]||(o[2]=f=>t.email.assunto=f),rules:[t.ruleObrigatorio],filled:"",col:"12",rotulo:"Assunto"},null,8,["modelValue","rules"]),a(l,{modelValue:t.email.mensagem,"onUpdate:modelValue":o[3]||(o[3]=f=>t.email.mensagem=f),rules:[t.ruleObrigatorio],autogrow:"",autofocus:"",filled:"",col:"12",rotulo:"Mensagem",tipo:"textoArea"},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])}var K=k(X,[["render",G]]);const Y={data(){return{email:{de:"",para:"",assunto:"",mensagem:""},ruleObrigatorio:e=>(e||"").trim().length||"Preenchimento obrigat\xF3rio"}},methods:{async enviarBoletoEmail(e){const{showLoading:o,successMsg:i,errorMsg:s}=e!=null?e:{};try{(o==null||o)&&$q.loading.show({message:"Envio de e-mail em andamento...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const t=[{name:"boleto.pdf",content:this.url,method:"url2pdf"}],n={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"drab azmd uvtf izhd"},from:this.email.de,to:this.email.para,subject:this.email.assunto,text:this.email.mensagem,attachments:t},l=await $({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:n});this.$q.notifyPositive((l==null?void 0:l.status)===200&&i?i:l.data.message)}catch(t){this.$q.notifyError(s||"Erro ao enviar e-mail",t)}finally{this.$q.loading.hide()}},async enviarBoletoEmailAutomatico(e,o){try{(showLoading==null||showLoading)&&$q.loading.show({message:"Envio de e-mail em andamento...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const i=[{name:"boleto.pdf",content:o,method:"url2pdf"}],s={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"drab azmd uvtf izhd"},from:emailDe,to:emailPara,subject:"Boleto Automatico",text:"Boleto envio automatico",attachments:i},t=await $({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:s});this.$q.notifyPositive((t==null?void 0:t.status)===200&&successMsg?successMsg:t.data.message)}catch(i){this.$q.notifyError("Erro ao abrir o boleto",i)}},async abrirBoletoEmail(e,o){try{this.html=o,this.url=o;const s=`
            SELECT EmpresaNome, EmpresaNumeroDocumento, REPLACE(valorTotal,'.',',') valorTotal, CONVERT(VARCHAR, DataVencimento, 103) DataVencimento , NossoNumero,
              NossoNumeroDv, LinhaDigitavel
            from FinanceiroBoleto where codigoFinanceiroBoleto = ${o.split("?")[1].split("&")[0].split("=")[1]}`,t=(await $utils.executarSql(s))[0];this.email={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:"",assunto:`${t.EmpresaNome} - Boleto N\xBA ${t.NossoNumero}-${t.NossoNumeroDv} `,mensagem:`Voc\xEA est\xE1 recebendo o arquivo digital do Boleto da empresa ${t.EmpresaNome} (CNPJ: ${t.EmpresaNumeroDocumento}). No valor de ${t.valorTotal} com vencimento em ${t.DataVencimento}, segue a linha digit\xE1vel:

${t.LinhaDigitavel}`},this.$refs.dialogBoletoEmail.show()}catch(i){this.$q.notifyError("Erro ao abrir o boleto",i)}}},mounted(){$utils.emitter.off("abrirBoletoEmail"),$utils.emitter.on("abrirBoletoEmail",this.abrirBoletoEmail)},beforeUnmount(){$utils.emitter.off("enviarNFeEmailAutomatico"),$utils.emitter.off("abrirBoletoEmail")}},Z={class:"q-py-sm"};function ee(e,o,i,s,t,n){const l=b("campo"),m=b("dialogForm");return d(),h(m,{ref:"dialogBoletoEmail",title:"Boleto / Email",labelButtonSubmit:"Enviar",size:"md",onSubmit:n.enviarBoletoEmail},{default:r(()=>[v("div",Z,[a(l,{modelValue:t.email.de,"onUpdate:modelValue":o[0]||(o[0]=u=>t.email.de=u),col:"12",rotulo:"De","somente-leitura":"",class:"col-12 q-field--with-bottom"},null,8,["modelValue"]),a(l,{modelValue:t.email.para,"onUpdate:modelValue":o[1]||(o[1]=u=>t.email.para=u),col:"12",rotulo:"Para",rules:[t.ruleObrigatorio],class:"col-12 q-field--with-bottom"},null,8,["modelValue","rules"]),a(l,{modelValue:t.email.assunto,"onUpdate:modelValue":o[2]||(o[2]=u=>t.email.assunto=u),col:"12",rotulo:"Assunto",rules:[t.ruleObrigatorio],class:"col-12 q-field--with-bottom"},null,8,["modelValue","rules"]),a(l,{modelValue:t.email.mensagem,"onUpdate:modelValue":o[3]||(o[3]=u=>t.email.mensagem=u),col:"12",rotulo:"Mensagem",tipo:"textoArea",autogrow:"",autofocus:"",rules:[t.ruleObrigatorio]},null,8,["modelValue","rules"])])]),_:1},8,["onSubmit"])}var oe=k(Y,[["render",ee]]);const te={components:{NFeEmail:K,BoletoEmail:oe,Visualizador:J},computed:{nome(){return this.$route.params.nome},parametro(){const{parametro:e}=this.$route.params;return e?$utils.base64.decodeFromUrl(e):""}},data(){return{impressao:null,impressorasRemotas:[],botaoImprimir:!0,componente:null,objeto:{},urlCompartilhamento:"",editarMsgWhatsapp:!1,configuracoesTexto:"",boleto:!1,urlBoleto:""}},methods:{async visualizadorIsMounted(){if(this.nome==="nfe-danfe"&&T()==="emitirNFe"){let e=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML,o=0,i=0;const s=500,t=5e3;await new Promise(n=>{const l=setInterval(()=>{const m=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;e===m?(o++,i+=50):(o=0,i=0),e=m,(i>=s||o>=10)&&(clearInterval(l),n()),i>=t&&(clearInterval(l),n())},50)}),$utils.emitter.emit("enviarNFeEmailAutomatico",this.parametro,e)}},abrirNFeEmail(){$utils.emitter.emit("abrirNFeEmail",this.parametro,this.$refs.visualizador.$el.contentWindow.document.body.innerHTML)},abrirBoletoEmail(){$utils.emitter.emit("abrirBoletoEmail",10,this.urlBoleto)},async carregarObjeto(e){try{const o=await L.objeto.le({filtros:{nomeObjeto:e,tipo:"vue"}});if(!o||!o[0]||!o[0].codigoPersonalizado)return this.$q.notify("Relat\xF3rio indispon\xEDvel ou sem permiss\xE3o");this.objeto=o[0];const i=JSON.parse($utils.base64.decode(o[0].codigoPersonalizado));this.componente={parametro:this.parametro,estilo:i.estilo,script:i.script,template:i.template}}catch{$q.notify({message:"N\xE3o foi poss\xEDvel carregar a impress\xE3o.",type:"negative"})}},async copiarLink(){const e=this.$refs.urlCompartilhamento;e.type="text",await this.$nextTick();try{e.select(),document.execCommand("copy"),this.$q.notify({message:"Copiado para a \xE1rea de transfer\xEAncia",type:"info"})}catch(o){this.$q.notifyError("Erro ao copiar",o)}e.type="hidden",window.getSelection().removeAllRanges()},async compartilhar(){let e="";try{if(this.$q.loading.show(),this.boleto)this.urlCompartilhamento=this.urlBoleto,e=this.urlBoleto;else{const s=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;e=(await $({baseURL:"https://api.b15.com.br",method:"post",url:"/html2pdf",data:{html:s}})).data.url,this.urlCompartilhamento=e}}catch(s){return this.$q.notifyError("Erro ao gerar o link de compartilhamento.",s)}finally{this.$q.loading.hide()}const o=this.objeto.descricao||"Relat\xF3rio",i=[{label:"Copiar link",icon:"link",handler:this.copiarLink},{color:"green",label:"WhatsApp",icon:"message",handler:()=>{this.editarMsgWhatsapp=!0}}];navigator.share&&i.push({label:"Outros",icon:"more_horiz",handler:()=>{navigator.share({title:o,url:e})}}),this.$q.bottomSheet({grid:!0,title:"Compartilhar",actions:i}).onOk(s=>{s.handler()})},async enviarMensagemWhatsapp(){const e=await $erp().configuracoes.where({nome:"imprimir.compartilhar.whatsapp.mensagem"}).first()||null;e?await $db.configuracoes.grava({atual:{id:e==null?void 0:e.id,nome:(e==null?void 0:e.nome)||"",valor:(e==null?void 0:e.valor)||"",texto:this.configuracoesTexto||(e==null?void 0:e.texto)||"",observacao:(e==null?void 0:e.observacao)||"",idEmpresa:(e==null?void 0:e.idEmpresa)||""}}):await $db.configuracoes.grava({atual:{id:$utils.uuid(),nome:"imprimir.compartilhar.whatsapp.mensagem",valor:"",texto:this.configuracoesTexto||"Acesse o documento atrav\xE9s do link:",observacao:"",idEmpresa:""}});const o=`${this.configuracoesTexto} ${this.urlCompartilhamento}`;H(`https://wa.me/?text=${o}`)},async impressaoRemota(e){const o=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;await $utils.p2p.enviarMensagem(e.idDispositivo,JSON.stringify({content:o,printerName:e.nome}),"/print")},imprimirVisualizador(){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.printer){const e=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;return cordova.plugins.printer.print(e)}if(this.boleto){const e=window.open(this.urlBoleto,"_blank");setTimeout(()=>{e?e.onload=function(){e.print()}:console.console("Falha ao abrir a nova aba.")},1500)}else this.$refs.visualizador.$el.contentWindow.print()},voltar(){window&&window.history.back()},carregarBoleto(e){this.objeto.descricao="Imprimir Boleto",this.boleto=!0,this.urlBoleto=atob(e),this.urlCompartilhamento=atob(e),$utils.emitter.emit("enviarBoletoEmailAutomatico",this.urlBoleto)}},async created(){var i;const e=await $db.configuracoes.leLista("integrador.idDispositivo"),o=[];for(const s of e)!/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/.test(s.valor)||!((i=s.texto)!=null&&i.trim())||o.push({idDispositivo:s.valor,nome:s.texto});this.impressorasRemotas=o},async mounted(){var o;/^\{.+\}$/gi.test(this.parametro)&&(this.impressao=((o=JSON.parse(this.parametro))==null?void 0:o.impressao)||null);const e=(await $db.configuracoes.le({nome:"imprimir.compartilhar.whatsapp.mensagem"}))[0]||[];if(this.configuracoesTexto=(e==null?void 0:e.texto)||"Acesse o documento atrav\xE9s do link:",this.nome==="tela-de-boleto-automatico")return this.carregarBoleto(this.parametro);if(this.nome&&this.nome!=="0")return this.carregarObjeto(this.nome);this.$q.notify("Impress\xE3o inv\xE1lida")}},ae={id:"imprimir"},ie={class:"Imprimir-visualizador"},re=["src"],le={class:"border-full border-radius q-mt-md q-pa-sm"};function se(e,o,i,s,t,n){const l=b("visualizador"),m=b("NFeEmail"),u=b("BoletoEmail");return d(),_("div",ae,[a(M,{elevated:"",class:"bg-gradiente text-white Imprimir-barraTopo"},{default:r(()=>[a(x,{class:"q-px-sm"},{default:r(()=>[a(p,{onClick:n.voltar,icon:"arrow_back",flat:"",round:"",dense:""},null,8,["onClick"]),a(C,null,{default:r(()=>[g(w(t.objeto.descricao||"Relat\xF3rio"),1)]),_:1}),n.nome==="nfe-danfe"?(d(),h(p,{key:0,onClick:n.abrirNFeEmail,label:"Email",icon:"email",flat:"",color:"white"},null,8,["onClick"])):E("",!0),n.nome==="tela-de-boleto-automatico"?(d(),h(p,{key:1,color:"white",flat:"",label:"Email",icon:"email",onClick:n.abrirBoletoEmail},null,8,["onClick"])):E("",!0),y(v("input",{"onUpdate:modelValue":o[0]||(o[0]=c=>t.urlCompartilhamento=c),ref:"urlCompartilhamento",type:"hidden"},null,512),[[D,t.urlCompartilhamento]]),t.impressao!=="etiquetas"?(d(),h(p,{key:2,onClick:o[1]||(o[1]=c=>e.tryLoading(n.compartilhar)),label:"Compartilhar",icon:"share",flat:"",color:"white"})):E("",!0),t.impressorasRemotas.length>0?(d(),h(p,{key:3,label:"Imprimir",icon:"print",flat:"",color:"white"},{default:r(()=>[a(S,null,{default:r(()=>[y((d(),h(I,{link:"",separator:""},{default:r(()=>[a(V,{onClick:n.imprimirVisualizador,clickable:""},{default:r(()=>[a(N,{avatar:""},{default:r(()=>[a(B,{name:"mdi-printer"})]),_:1}),a(N,null,{default:r(()=>[a(q,null,{default:r(()=>o[5]||(o[5]=[g("Local")])),_:1})]),_:1})]),_:1},8,["onClick"]),(d(!0),_(j,null,U(t.impressorasRemotas,(c,f)=>(d(),h(V,{key:f,onClick:ne=>n.impressaoRemota(c),clickable:""},{default:r(()=>[a(N,{avatar:""},{default:r(()=>[a(B,{name:"mdi-cloud-print-outline"})]),_:1}),a(N,null,{default:r(()=>[a(q,null,{default:r(()=>[g(w(c.nome),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[F]])]),_:1})]),_:1})):(d(),h(p,{key:4,onClick:n.imprimirVisualizador,label:"Imprimir",icon:"print",flat:"",color:"white"},null,8,["onClick"]))]),_:1})]),_:1}),a(z,{class:"Imprimir-pagina"},{default:r(()=>[a(A,null,{default:r(()=>[v("div",ie,[t.componente?(d(),h(l,{key:0,onMounted:n.visualizadorIsMounted,componente:t.componente,ref:"visualizador"},null,8,["onMounted","componente"])):E("",!0),t.boleto?(d(),_("iframe",{key:1,ref:"boletoVisualizador",src:t.urlBoleto,style:{border:"0px",display:"block",height:"100%",width:"100%"}},null,8,re)):E("",!0)])]),_:1})]),_:1}),a(m),a(u),a(W,{modelValue:t.editarMsgWhatsapp,"onUpdate:modelValue":o[4]||(o[4]=c=>t.editarMsgWhatsapp=c)},{default:r(()=>[a(R,{container:"",view:"hHh Lpr fFf",class:"bg-white",style:{"max-height":"400px"}},{default:r(()=>[a(M,null,{default:r(()=>[a(x,null,{default:r(()=>[y(a(p,{icon:"arrow_back",flat:"",round:""},null,512),[[F]]),a(C,null,{default:r(()=>o[6]||(o[6]=[g("Enviar mensagem WhatsApp")])),_:1})]),_:1})]),_:1}),a(z,null,{default:r(()=>[a(A,{class:"q-pa-md"},{default:r(()=>[a(O,{modelValue:t.configuracoesTexto,"onUpdate:modelValue":o[2]||(o[2]=c=>t.configuracoesTexto=c),type:"textarea",label:"Mensagem",filled:"",dense:""},null,8,["modelValue"]),v("p",le,[o[7]||(o[7]=v("span",{class:"text-weight-medium"},[g("Visualizar como esta \xE1 mensagem:"),v("br")],-1)),g(" "+w(t.configuracoesTexto)+" "+w(t.urlCompartilhamento),1)])]),_:1})]),_:1}),a(P,{class:"bg-light"},{default:r(()=>[a(x,null,{default:r(()=>[a(Q),y(a(p,{flat:"",label:"Cancelar",color:"tertiary"},null,512),[[F]]),a(p,{onClick:o[3]||(o[3]=c=>n.enviarMensagemWhatsapp()),label:"Enviar",color:"primary",unelevated:""})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var de=k(te,[["render",se],["__scopeId","data-v-0e6dee81"]]);export{de as default};
