import{_ as ee,bi as ae,bj as M,bk as O,bl as D,bn as T,r as C,o as m,d as f,w as a,f as o,M as ie,G as le,h as W,Q as V,i as Y,k as n,I as re,J as se,t as h,p as z,e as b,F as U,bf as oe,P as H,x as Q,S as A,T as v,U as w,C as _,m as q,l as te,K as ne,D as de,j as E,aN as R,H as ue,N as me}from"./index.ddbcd6b2.js";import{L as ce}from"./Lista.b4055103.js";import{P as fe}from"./PromptContatoV2.428cc115.js";const pe={components:{PromptItemV2:ae,PromptContatoV2:fe},data(){return{visivel:!1,cliente:{},emitente:{},diaVencimento:"",documentoAnterior:{},documento:{id:M(),dataHoraEmissao:O(),numero:"",descricaoContato:"",idContato:"",descricaoEmpresa:"",idEmpresa:"",numeroVolumeTransporte:"",status:"Ativo",tipo:"Contrato"},documentoItens:[],documentoItensAnterior:[],totalItens:0,itensModal:!1,contatosModal:!1,emitenteModal:!1,empresas:[],configImpressaoContrato:[]}},emits:["atualizar"],methods:{async atualizar(l){if($q.loading.show(),l=l||this.$route.params.id,l)this.documentoAnterior=await $db.hibrido.le({table:"documento",id:l}),this.documento=D(this.documentoAnterior),this.documentoItensAnterior=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:l}}),this.documentoItens=D(this.documentoItensAnterior),this.cliente.id=this.documento.idContato,this.cliente.nome=this.documento.descricaoContato,this.emitente.id=this.documento.idEmpresa,this.emitente.nome=this.documento.descricaoEmpresa,this.diaVencimento=this.documento.numeroVolumeTransporte;else{this.limparCampos(),this.documento.id=M(),this.documento.dataHoraEmissao=O(),this.documento.status="Ativo",this.documento.tipo="Contrato";const e=await $g.promptContato.show({filtro:{ativo:!0,empresas:!0},placeholder:"Selecione"});this.emitente=D(e),this.documento.idEmpresa=this.emitente.id,this.documento.descricaoEmpresa=this.emitente.nome}this.empresas=await $db.hibrido.lista({table:"empresa"}),this.somarValorTotal(),this.configuraImpressaoContrato(this.documento.idEmpresa),$q.loading.hide()},fechar(){this.$router.replace({params:{id:""}}),this.limparCampos(),this.visivel=!1},limparCampos(){this.documentoAnterior={},this.documento={id:"",dataHoraEmissao:null,numero:"",descricaoContato:"",idContato:"",descricaoEmpresa:"",idEmpresa:"",numeroVolumeTransporte:"",status:"",tipo:""},this.documentoItensAnterior=[],this.documentoItens=[],this.cliente.id="",this.cliente.nome="",this.emitente.id="",this.emitente.nome="",this.diaVencimento=""},async configuraImpressaoContrato(l){const e=await $db.configuracoes.porNome("impressao.contrato",l);this.configImpressaoContrato=e},async abrirModal(l=""){let e={},u=[];l?u=this.documentoItens.filter(c=>c.idItem===l):u=this.documentoItens;for(const c of u)e[c.idItem]={item:await $db.hibrido.le({table:"item",id:c.idItem}),quantidade:c.quantidade};this.$refs.promptItem.itensSelecionados=e,this.$refs.promptItem.termo=l,this.$refs.promptItem.atualizar(),this.itensModal=!0},recalcularTotal(l){l.subTotal=T(l.quantidade*l.valorItem),l.total=T(l.quantidade*l.valorItem),this.somarValorTotal()},aoSelecionarCliente(l,e){},async selecionarCliente(){if(this.documento.status!=="Cancelado"){const l=await $g.promptContato.show({filtro:{ativo:!0},placeholder:"Selecione"});this.cliente=D(l),this.contatosModal=!1,this.documento.idContato=this.cliente.id,this.documento.descricaoContato=this.cliente.nome}},async selecionarEmitente(l,e){if(!l){this.emitenteModal=!1;return}this.emitente=D(e),this.emitenteModal=!1,this.documento.idEmpresa=this.emitente.id,this.documento.descricaoEmpresa=this.emitente.nome},aoSelecionarVencimento(){this.documento.numeroVolumeTransporte=this.diaVencimento},selecionarItens:function(l){for(const e in l){const u=l[e].item||{},c=l[e].quantidade||0;let t=this.documentoItens.find(r=>r.idItem===e);t?(t.quantidade=c,t.quantidadeRealizado=c,t.total=T(c*u.valorVenda)):this.documentoItens.push({dataHoraEmissao:O(),descricaoItem:u.descricao,id:M(),idDocumento:this.documento.id,idItem:u.id,operacao:"-",quantidade:c,unidade:u.unidade,quantidadeRealizado:c,tipoItem:u.tipo,total:T(c*u.valorVenda),valorItem:u.valorVenda})}this.somarValorTotal()},somarValorTotal(){this.totalItens=this.documentoItens.reduce((l,e)=>l+=e.total,0)},excluirItem(l){this.documentoItens=this.documentoItens.filter(e=>e.id!==l),this.somarValorTotal()},validaDia(){if(this.diaVencimento<1||this.diaVencimento>28){this.$q.notifyAlert("O dia deve ser um valor entre 1 e 28"),this.diaVencimento="";return}this.aoSelecionarVencimento()},async gravar(l=!1){if(!this.cliente.id){this.$q.notifyAlert("Selecione um Cliente");return}if(!this.emitente.id){this.$q.notifyAlert("Selecione um Emitente");return}if(!this.diaVencimento){this.$q.notifyAlert("Selecione um dia de Vencimento");return}if(!this.totalItens){this.$q.notifyAlert("Adicione alguns itens ao contrato");return}try{await $db.contrato.grava({documentoAnterior:this.documentoAnterior,documento:this.documento,documentoItensAnterior:this.documentoItensAnterior,documentoItens:this.documentoItens}),this.visivel=l,this.atualizar(this.documento.id),this.$emit("atualizar")}catch(e){this.$q.notifyError("Erro ao salvar",e)}},cancelar(){this.documento.status="Cancelado",this.documento.dataHoraFinalizado=O(),this.gravar(!0),$q.notifyPositive("Contrato Cancelado")},ativar(){this.documento.status="Ativo",this.documento.dataHoraFinalizado="",this.gravar(!0),$q.notifyPositive("Contrato Reativado")}}},he={key:0},be={ref:"form"},ve={class:"u-container"};function ge(l,e,u,c,t,r){const k=C("badge"),S=C("BadgeCopiarUid"),y=C("avatar"),s=C("g-col"),x=C("campo"),i=C("g-row"),p=C("g-label"),B=C("PromptItemV2"),L=C("PromptContatoV2");return m(),f(de,{modelValue:t.visivel,"onUpdate:modelValue":e[11]||(e[11]=d=>t.visivel=d),maximized:"",onHide:e[12]||(e[12]=d=>r.fechar())},{default:a(()=>[o(ie,{view:"hHh LpR fFf",container:"",class:"bg-light"},{default:a(()=>[o(le,null,{default:a(()=>[o(W,null,{default:a(()=>[o(V,{onClick:e[0]||(e[0]=d=>r.fechar()),icon:"arrow_back",round:"",dense:"",flat:""}),o(Y,null,{default:a(()=>e[13]||(e[13]=[n("Contrato")])),_:1}),o(V,{onClick:e[1]||(e[1]=d=>r.gravar(!1)),label:"Salvar",color:"white","text-color":"primary",unelevated:""})]),_:1})]),_:1}),o(re,{class:"u-container"},{default:a(()=>[o(se,null,{default:a(()=>[o(W,{color:"transparent",class:"q-my-md"},{default:a(()=>[o(Y,{class:"text-body2"},{default:a(()=>[n(" Emiss\xE3o: "+h(l.$filters.data(t.documento.dataHoraEmissao))+" ",1),t.documento.dataHoraFinalizado?(m(),z("span",he,", Cancelamento: "+h(l.$filters.data(t.documento.dataHoraFinalizado)),1)):b("",!0)]),_:1}),t.documento.status?(m(),f(k,{key:0,rotulo:t.documento.status,escuro:"",dica:"Status",class:"q-ml-sm",cor:t.documento.status==="Ativo"?"primary":"tertiary"},null,8,["rotulo","cor"])):b("",!0),t.documento.numero?(m(),f(S,{key:1,id:t.documento.id,numero:t.documento.numero,cor:t.documento.status==="Ativo"?"positive":"tertiary",dica:"C\xF3digo: "+t.documento.codigoDocumento,class:"q-ml-sm"},null,8,["id","numero","cor","dica"])):b("",!0),t.documento.numero?(m(),z(U,{key:2},[t.configImpressaoContrato.length>1?(m(),f(V,{key:0,icon:"print",color:"primary",round:"",dense:"",flat:"",class:"q-ml-xs"},{default:a(()=>[o(oe,{self:"top middle",anchor:"bottom middle"},{default:a(()=>[o(H,{link:"",separator:""},{default:a(()=>[(m(!0),z(U,null,Q(t.configImpressaoContrato.filter(d=>d.valor),d=>(m(),f(A,{key:d.valor,onClick:F=>l.$imprimir(d.valor,{id:(t.documento||{}).id||"0",Oculto:"0"})},{default:a(()=>[o(v,{icon:"print"}),o(w,{label:d.texto},null,8,["label"])]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})):(m(),f(V,{key:1,icon:"print",color:"primary",round:"",dense:"",flat:"",class:"q-ml-xs",onClick:e[2]||(e[2]=d=>l.$imprimir(t.configImpressaoContrato[0].valor,{id:(t.documento||{}).id||"0",Oculto:"0"}))}))],64)):b("",!0)]),_:1}),_("form",be,[o(i,{gutter:"md",mg:"md-y",bg:"bg-white","rounded-borders":""},{default:a(()=>[o(s,{col:"12 sm"},{default:a(()=>[o(i,null,{default:a(()=>[o(s,{col:"shrink"},{default:a(()=>[o(y,{imagem:t.emitente.imagem,rotulo:t.emitente.nome,tamanho:"40",style:{float:"left"}},null,8,["imagem","rotulo"])]),_:1}),o(s,{col:"grow"},{default:a(()=>[o(x,{modelValue:t.emitente.nome,"onUpdate:modelValue":e[3]||(e[3]=d=>t.emitente.nome=d),rotulo:"Emitente",tipo:"texto",disable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(s,{col:"12 sm"},{default:a(()=>[o(i,null,{default:a(()=>[o(s,{col:"shrink"},{default:a(()=>[o(y,{imagem:t.cliente.imagem,rotulo:t.cliente.nome,tamanho:"30",style:{float:"left"}},null,8,["imagem","rotulo"])]),_:1}),o(s,{col:"grow"},{default:a(()=>[o(x,{modelValue:t.cliente.nome,"onUpdate:modelValue":[e[4]||(e[4]=d=>t.cliente.nome=d),r.aoSelecionarCliente],onClick:r.selecionarCliente,after:[{icon:"edit",handler(){r.selecionarCliente()}}],somenteLeitura:t.documento.status==="Cancelado",placeholder:"Cliente",rotulo:"Cliente",tipo:"texto"},null,8,["modelValue","onUpdate:modelValue","onClick","after","somenteLeitura"])]),_:1})]),_:1})]),_:1}),o(s,{col:"12 sm"},{default:a(()=>[o(x,{modelValue:t.diaVencimento,"onUpdate:modelValue":e[5]||(e[5]=d=>t.diaVencimento=d),onBlur:r.validaDia,opcoes:{minimumValue:1,maximumValue:28},error:t.diaVencimento>28||t.diaVencimento<1,rotulo:"Dia de Vencimento",tipo:"numero",errorMessage:"Dia entre 1 e 28",placeholder:"Dia Vencimento"},null,8,["modelValue","onBlur","error"])]),_:1})]),_:1})],512),o(i,{gutter:"md",mg:"md-y",bg:"bg-white","rounded-borders":""},{default:a(()=>[o(s,{col:"grow"},{default:a(()=>[o(p,{icon:"shopping_cart sm tertiary left"},{default:a(()=>e[14]||(e[14]=[n("Produtos e Servi\xE7os")])),_:1})]),_:1}),o(s,{col:"shrink"},{default:a(()=>[t.documento.status!=="Cancelado"?(m(),f(V,{key:0,onClick:e[6]||(e[6]=d=>r.abrirModal()),icon:"add",size:"md",color:"positive",round:"",dense:"",flat:""},{default:a(()=>[o(q,{anchor:"bottom middle",self:"center middle"},{default:a(()=>e[15]||(e[15]=[n("Adicionar Item")])),_:1})]),_:1})):b("",!0)]),_:1}),o(s,{col:"12"},{default:a(()=>[o(H,null,{default:a(()=>[o(i,{class:"hideonmobile",justify:"around",text:"bold"},{default:a(()=>[o(s,{col:"2 md"},{default:a(()=>e[16]||(e[16]=[n("C\xF3digo")])),_:1}),o(s,{col:"10 md4 "},{default:a(()=>e[17]||(e[17]=[n("Descri\xE7\xE3o")])),_:1}),o(s,{col:"6 md",text:"right"},{default:a(()=>e[18]||(e[18]=[n("Quantidade")])),_:1}),o(s,{col:"6 md",text:"right"},{default:a(()=>e[19]||(e[19]=[n("Valor")])),_:1}),o(s,{col:"6 md",text:"right"},{default:a(()=>e[20]||(e[20]=[n("Total")])),_:1}),o(s,{col:"6 md1",text:"center"},{default:a(()=>e[21]||(e[21]=[n("A\xE7\xF5es")])),_:1})]),_:1}),o(te,{class:"q-mt-xs q-mb-sm"}),(m(!0),z(U,null,Q(t.documentoItens,(d,F)=>(m(),f(i,{key:F,items:"center",justify:"center",bordered:"bottom"},{default:a(()=>[o(s,{col:"grow md",order:"xs0 sm0"},{default:a(()=>[o(i,{items:"center",justify:"center"},{default:a(()=>[o(s,{col:"2",text:"left",class:"hideondesktop"},{default:a(()=>e[22]||(e[22]=[n(" C\xF3d.: ")])),_:1}),o(s,{col:"grow"},{default:a(()=>[n(h(d.codigoItem||"-"),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(s,{col:"12 md4",order:"xs2 sm1"},{default:a(()=>[o(i,{items:"center",justify:"center"},{default:a(()=>[o(s,{col:"2",text:"left",class:"hideondesktop"},{default:a(()=>e[23]||(e[23]=[n(" Desc.: ")])),_:1}),o(s,{col:"grow"},{default:a(()=>[n(h(d.descricaoItem||"-"),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(s,{col:"12 md",order:"xs3 sm2"},{default:a(()=>[o(i,{items:"center",justify:"center"},{default:a(()=>[o(s,{col:"2",text:"left",class:"hideondesktop"},{default:a(()=>[o(p,{class:"q-mr-xs"},{default:a(()=>e[24]||(e[24]=[n("Qtd.:")])),_:1})]),_:1}),o(s,{col:"grow sm10",text:"right"},{default:a(()=>[o(x,{modelValue:d.quantidade,"onUpdate:modelValue":I=>d.quantidade=I,onBlur:I=>r.recalcularTotal(d),tipo:"decimal",decimals:"4",filled:""},null,8,["modelValue","onUpdate:modelValue","onBlur"])]),_:2},1024),o(s,{col:"2",text:"center"},{default:a(()=>[o(p,null,{default:a(()=>[n(h(d.unidade||"-"),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(s,{col:"12 md",order:"xs4 sm3"},{default:a(()=>[o(i,{items:"center",justify:"center"},{default:a(()=>[o(s,{col:"2",text:"left",class:"hideondesktop"},{default:a(()=>e[25]||(e[25]=[n(" Valor: ")])),_:1}),o(s,{col:"grow",text:"right"},{default:a(()=>[o(x,{modelValue:d.valorItem,"onUpdate:modelValue":I=>d.valorItem=I,onBlur:I=>r.recalcularTotal(d),tipo:"decimal",decimals:"4",filled:""},null,8,["modelValue","onUpdate:modelValue","onBlur"])]),_:2},1024)]),_:2},1024)]),_:2},1024),o(s,{col:"12 md",order:"xs5 sm4"},{default:a(()=>[o(i,{items:"center",justify:"center"},{default:a(()=>[o(s,{col:"2",text:"left",class:"hideondesktop"},{default:a(()=>e[26]||(e[26]=[n(" Total: ")])),_:1}),o(s,{col:"grow",text:"right"},{default:a(()=>[n(h(l.$filters.numero(d.total,2)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(s,{col:"shrink md1",order:"xs1 sm5",text:"center"},{default:a(()=>[o(V,{onClick:I=>r.abrirModal(d.idItem),icon:"edit",round:"",dense:"",flat:""},{default:a(()=>[o(q,{anchor:"bottom middle",self:"center middle"},{default:a(()=>e[27]||(e[27]=[n("Editar")])),_:1})]),_:2},1032,["onClick"]),o(V,{onClick:I=>r.excluirItem(d.id),icon:"delete",round:"",dense:"",flat:""},{default:a(()=>[o(q,{anchor:"bottom middle",self:"center middle"},{default:a(()=>e[28]||(e[28]=[n("Excluir")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128)),o(i,{items:"center",justify:"center"},{default:a(()=>[o(s,{col:"grow md"},{default:a(()=>e[29]||(e[29]=[n("\xA0")])),_:1}),o(s,{col:"10 md4"},{default:a(()=>e[30]||(e[30]=[n("\xA0")])),_:1}),o(s,{col:"12 md",text:"right"},{default:a(()=>e[31]||(e[31]=[n("\xA0")])),_:1}),o(s,{col:"12 md",text:"right"},{default:a(()=>e[32]||(e[32]=[n("\xA0")])),_:1}),o(s,{col:"12 md",text:"right"},{default:a(()=>[n(h(l.$filters.numero(t.totalItens,2)),1)]),_:1}),o(s,{col:"12 md1",text:"right"},{default:a(()=>e[33]||(e[33]=[n("\xA0")])),_:1})]),_:1}),o(i,{items:"center",justify:"center"},{default:a(()=>[o(s,{col:"12",text:"center"},{default:a(()=>[o(V,{onClick:e[7]||(e[7]=d=>r.abrirModal()),label:"Adicionar item",icon:"add",size:"xs",color:"positive",outline:"",class:"q-mx-auto"})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),o(B,{modelValue:t.itensModal,"onUpdate:modelValue":e[8]||(e[8]=d=>t.itensModal=d),onSelecionarItens:r.selecionarItens,filtro:{ativo:!0,idEmpresa:t.documento.idEmpresa},habilitarQuantidade:!0,ref:"promptItem"},null,8,["modelValue","onSelecionarItens","filtro"]),o(L,{modelValue:t.contatosModal,"onUpdate:modelValue":e[9]||(e[9]=d=>t.contatosModal=d),onSelecionar:r.aoSelecionarCliente,filtro:{ativo:!0},placeholder:"Seleciona o Cliente"},null,8,["modelValue","onSelecionar"]),o(L,{modelValue:t.emitenteModal,"onUpdate:modelValue":e[10]||(e[10]=d=>t.emitenteModal=d),onSelecionar:r.selecionarEmitente,filtro:{ativo:!0,empresas:!0},placeholder:"Seleciona a empresa emitente"},null,8,["modelValue","onSelecionar"])]),_:1})]),_:1}),o(ne,{class:"q-pa-sm bg-white text-right",bordered:""},{default:a(()=>[_("div",ve,[t.documento.status==="Cancelado"?(m(),f(V,{key:0,onClick:r.ativar,label:"Ativar",color:"primary",unelevated:""},null,8,["onClick"])):b("",!0),t.documento.status==="Ativo"?(m(),f(V,{key:1,onClick:r.cancelar,label:"Cancelar",color:"negative",flat:""},null,8,["onClick"])):b("",!0)])]),_:1})]),_:1})]),_:1},8,["modelValue"])}var Ce=ee(pe,[["render",ge]]);const ke={components:{Lista:ce,ContratoFicha:Ce},data(){return{usuario:"",permissao:{outrasEmpresas:!1},listaLayout:[],lista:[],mostrar:{header:!0,barraTopo:!0,toolbarTitulo:!0,icone:"gavel",titulo:"Contratos",buscar:!0,filtroAvancado:!0,btnAjuda:!0,btnAtualizar:!0,btnNovo:!0,toolbarAcoes:!0,checkBox:!1,btnRemover:!1,btnRestaurar:!1,centralizaTabs:!1,btnDetalhes:!1,btnExportaXLS:!1,btnMenuMais:!0,toolbarAdicao:!1,bannerMsg:"",conexao:{icone:"hibrido",iconeTamanho:"xs",cor:"grey-5",rotulo:null,dica:"H\xEDbrido",denso:!0,flat:!0,escuro:!1}},busca:"",filtrosOriginal:{},filtros:{status:"Ativo",empresa:"",periodoEmissao:{ini:"",fim:""},periodoFinalizado:{ini:"",fim:""},ordenacao:"numero",direcao:"desc"},empresaOpcoes:[],ordenacaoOpcoes:[{value:"numero",label:"N\xFAmero Contrato"},{value:"codigoDocumento",label:"C\xF3digo Documento"},{value:"dataHoraEmissao",label:"Data de emiss\xE3o"},{value:"dataHoraFinalizado",label:"Data finalizado"}],direcaoOpcoes:[{value:"asc",label:"Crescente"},{value:"desc",label:"Decrescente"}],checkBox:!1,tabSelecionada:{valor:"Ativo"},tabs:[{valor:"Ativo",rotulo:"Ativos"},{valor:"Suspenso",rotulo:"Suspensos"},{valor:"Cancelado",rotulo:"Cancelados"},{valor:"Todos",rotulo:"Todos"}],paginacao:{atual:1,minimo:1,maximo:1,total:1,limite:25}}},methods:{async atualizar(l){var u;const e=$utils.logarIni("ContratosLista");await $tryLoading(async()=>{var x,i,p,B,L,d,F,I,P,j,N,$,G,J,Z,K,X;this.lista=[];let{buscarDadosRecentes:c}=l!=null?l:{},t={},r={};c&&(t=await $utils.localIDB.getItem({objectStore:"dadosRecentes",id:"ContratosLista_"+((x=this.usuario)==null?void 0:x.id)}),t!=null&&t._id&&(this.tabSelecionada.valor=(t==null?void 0:t.tabSelecionada)||"Ativo",this.busca=(t==null?void 0:t.busca)||"",this.filtros={status:((i=t==null?void 0:t.filtros)==null?void 0:i.status)||"Ativo",empresa:((p=t==null?void 0:t.filtros)==null?void 0:p.empresa)||"",periodoEmissao:{ini:((L=(B=t==null?void 0:t.filtros)==null?void 0:B.periodoEmissao)==null?void 0:L.ini)||"",fim:((F=(d=t==null?void 0:t.filtros)==null?void 0:d.periodoEmissao)==null?void 0:F.fim)||""},periodoFinalizado:{ini:((P=(I=t==null?void 0:t.filtros)==null?void 0:I.periodoFinalizado)==null?void 0:P.ini)||"",fim:((N=(j=t==null?void 0:t.filtros)==null?void 0:j.periodoFinalizado)==null?void 0:N.fim)||""},ordenacao:(($=t==null?void 0:t.filtors)==null?void 0:$.ordenacao)||"numero",direcao:((G=t==null?void 0:t.filtros)==null?void 0:G.direcao)||"desc"},this.compareObject(this.filtrosOriginal,this.filtros,["status","ordenacao","direcao"])&&(this.$refs.contratosLista.filtros=!0))),r=$utils.eliminarVazios(this.filtros),this.tabSelecionadaAnt!==this.tabSelecionada.valor&&(this.paginacao.atual=1),this.tabSelecionadaAnt=this.tabSelecionada.valor,this.mostrar.checkBox=!1,this.tabSelecionada.valor==="Ativo"&&(this.mostrar.checkBox=!0),delete r.status,((J=this.tabSelecionada)==null?void 0:J.valor)!=="Todos"&&(r.status=(Z=this.tabSelecionada)==null?void 0:Z.valor),this.busca&&(this.paginacao.atual=1,/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/.test(this.busca)?(this.tabSelecionada.valor="Todos",this.mostrar.checkBox=!1,r={id:this.busca}):r.termoBusca=this.busca);const k=[this.filtros.ordenacao],S=[this.filtros.direcao],y=await $db.contrato.leListaCompleta({filtros:r,limit:this.paginacao.limite,page:this.paginacao.atual,sort:k,dir:S});let s=!0;for(const g of y.data)g!=null&&g.documentoItens&&(g.totalContrato=$utils.somar(g==null?void 0:g.documentoItens,"total")),this.listaLayout.hasOwnProperty(g.id)||($db.hibrido.isOnline()||(g.documentoItens=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:g.id}})),this.listaLayout[g.id]={detalhes:!1,remover:!1}),this.listaLayout[g.id].remover||(s=!1);this.$refs.contratosLista.checkbox=(K=y==null?void 0:y.data)!=null&&K.length?s:!1,this.lista=y.data,this.paginacao.total=y.total,this.paginacao.maximo=y.totalPages,t={_id:"ContratosLista_"+((X=this.usuario)==null?void 0:X.id),tabSelecionada:this.tabSelecionada.valor,busca:this.busca,filtros:$utils.clonar(this.filtros)},await $utils.localIDB.setItem({objectStore:"dadosRecentes",data:t})}),$utils.logarFim(e,((u=this.paginacao)==null?void 0:u.total)||1)},async gerarLoteNFSe(){await this.$q.dialog({title:"Gerar lote de NFS-e",message:"Deseja gerar as notas de servi\xE7o a partir dos contratos?",cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(async()=>{const l=$utils.logarIni("ContratosLista");await $tryLoading(async()=>{await $db.contrato.gerarNFSEapartirContrato(),$q.notifyPositive("Exporta\xE7\xE3o das notas finalizada.")},{mensagem:"Exportando Contratos para NFSe...",erro:"Ocorreu um erro ao exportar contratos"}),$utils.logarFim(l,1)})},async criarClick(){await this.$refs.contrato.atualizar(),this.$refs.contrato.visivel=!0},async abrirItem(l){await this.$refs.contrato.atualizar(l),this.$refs.contrato.visivel=!0},checkBoxClick(){for(const l of this.lista)this.listaLayout[l.id].remover=this.checkBox,this.mostrar.btnRemover=this.checkBox},verificarListaLayout(){let l=!0;for(const e of this.lista)this.listaLayout[e.id].remover||(l=!1);this.$refs.contratosLista.checkbox=l,this.mostrar.btnRemover=Object.values(this.listaLayout).some(e=>e.remover===!0)},async removerItem(l){$q.dialog({title:"Remover",message:"Ao continuar voc\xEA ir\xE1 remover este item.",cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(async()=>{try{$q.loading.show(),await $db.contrato.remove(l.id),this.atualizar(),$q.notifyPositive("O contrato foi exclu\xEDdo com sucesso.")}catch(e){$q.notifyError("Ocorreu um erro ao remover contrato.",e)}finally{$q.loading.hide()}})},async removerTodos(){$q.dialog({title:"Remover contratos",message:"Deseja remover todos os contratos selecionados?",cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(async()=>{try{$q.loading.show();for(let l of this.lista)if(this.listaLayout[l.id].remover)try{await $db.contrato.remove(l.id)}catch{$q.notify("Ocorreu um erro ao remover os contratos selecionados. Tente novamente.")}this.atualizar(),$q.notifyPositive("Os contratos foram removidos com sucesso.")}catch(l){$q.notifyError("Ocorreu um erro ao remover todos os contratos selecionados.",l)}finally{$q.loading.hide()}})},async configurarPermissao(){this.permissao={outrasEmpresas:await $db.permissao.objeto("Diretiva_Venda/Fatura_OutrasLojas_VerTodos")}},async configurarEmpresas(){const l=[];let e=[];if(!this.permissao.outrasEmpresas){e=(await $db.contato.ler({filtros:{ativo:!0,empresas:!0}})).data;for(const u of e)l.push({label:u.nome,value:u.id})}if(this.permissao.outrasEmpresas){e=await $db.empresa.ler({filtro:{ativo:!0}});for(const u of e)l.push({label:u.nome,value:u.idContato})}this.empresaOpcoes=l==null?void 0:l.sort((u,c)=>{var t;return(t=u==null?void 0:u.label)==null?void 0:t.localeCompare(c==null?void 0:c.label)})},async limparFiltrosClick(){this.filtros=$utils.clonar(this.filtrosOriginal),await this.atualizar()},compareObject(l,e,u=[]){const c=Object.keys(l);for(const t of c)if(!u.includes(t)){if(typeof l[t]=="object"&&l[t]!==null){if(!this.compareObject(l[t],e[t],u))continue;return!0}else if(l[t]!==e[t])return!0}return!1}},async mounted(){this.usuario=JSON.parse(localStorage.getItem("usuario")),this.filtrosOriginal=$utils.clonar(this.filtros),await this.configurarPermissao(),await this.configurarEmpresas(),this.$route.params.id&&this.$route.params.id.length?(this.abrirItem(this.$route.params.id),this.busca=this.$route.params.id,await this.atualizar()):await this.atualizar({buscarDadosRecentes:!0})}},ye={id:"ContratosLista"},Ve={class:"mw80 text-center"},xe={class:"text-weight-medium"},Ie={class:"text-weight-medium"};function we(l,e,u,c,t,r){const k=C("campo"),S=C("BadgeCopiarUid"),y=C("avatar"),s=C("Lista"),x=C("ContratoFicha");return m(),z("div",ye,[o(s,{ref:"contratosLista",busca:t.busca,"onUpdate:busca":e[11]||(e[11]=i=>t.busca=i),checkBox:t.checkBox,"onUpdate:checkBox":e[12]||(e[12]=i=>t.checkBox=i),onAtualizar:r.atualizar,onCriarClick:r.criarClick,onRemoverClick:r.removerTodos,onCheckBoxClick:r.checkBoxClick,onLimparFiltrosClick:r.limparFiltrosClick,lista:t.lista,tabs:t.tabs,tabSelecionada:t.tabSelecionada,paginacao:t.paginacao,mostrar:t.mostrar},{menuExtras:a(()=>[o(A,{onClick:e[0]||(e[0]=i=>r.gerarLoteNFSe()),clickable:""},{default:a(()=>[o(v,{avatar:""},{default:a(()=>[o(E,{name:"mdi-file-replace",size:"sm"})]),_:1}),o(v,null,{default:a(()=>e[13]||(e[13]=[n("Gerar notas de servi\xE7o")])),_:1})]),_:1})]),filtroCampos:a(()=>[o(k,{modelValue:t.filtros.empresa,"onUpdate:modelValue":e[1]||(e[1]=i=>t.filtros.empresa=i),options:t.empresaOpcoes,dense:"",clearable:"",tipo:"seletor",rotulo:"Por empresa",class:"q-mt-sm"},null,8,["modelValue","options"]),o(k,{modelValue:t.filtros.periodoEmissao.ini,"onUpdate:modelValue":e[2]||(e[2]=i=>t.filtros.periodoEmissao.ini=i),dense:"",tipo:"data",rotulo:"Data emiss\xE3o",class:"q-mt-xl"},null,8,["modelValue"]),o(k,{modelValue:t.filtros.periodoEmissao.fim,"onUpdate:modelValue":e[3]||(e[3]=i=>t.filtros.periodoEmissao.fim=i),dense:"",tipo:"data",rotulo:"at\xE9",class:"q-mt-sm"},null,8,["modelValue"]),o(k,{modelValue:t.filtros.periodoFinalizado.ini,"onUpdate:modelValue":e[4]||(e[4]=i=>t.filtros.periodoFinalizado.ini=i),dense:"",rotulo:"Data finalizado",tipo:"data",class:"q-mt-xl"},null,8,["modelValue"]),o(k,{modelValue:t.filtros.periodoFinalizado.fim,"onUpdate:modelValue":e[5]||(e[5]=i=>t.filtros.periodoFinalizado.fim=i),dense:"",rotulo:"at\xE9",tipo:"data",class:"q-mt-sm"},null,8,["modelValue"]),o(k,{modelValue:t.filtros.ordenacao,"onUpdate:modelValue":e[6]||(e[6]=i=>t.filtros.ordenacao=i),options:t.ordenacaoOpcoes,dense:"",rotuloFixo:"Ordenar por",tipo:"seletor",class:"q-mt-xl"},null,8,["modelValue","options"]),o(k,{modelValue:t.filtros.direcao,"onUpdate:modelValue":e[7]||(e[7]=i=>t.filtros.direcao=i),options:t.direcaoOpcoes,dense:"",rotuloFixo:"Dire\xE7\xE3o",tipo:"seletor",class:"q-mt-sm"},null,8,["modelValue","options"]),o(k,{modelValue:t.paginacao.limite,"onUpdate:modelValue":e[8]||(e[8]=i=>t.paginacao.limite=i),dense:"",tipo:"quantidade",rotulo:"Quantidade por p\xE1gina",min:"1",class:"q-mt-xl q-mb-md"},null,8,["modelValue"])]),itemLista:a(()=>[o(H,{bordered:"",class:"bg-white q-mb-xs rounded-borders"},{default:a(()=>[(m(!0),z(U,null,Q(t.lista,i=>(m(),z("div",{key:i.id,class:"itemHover"},[o(A,{class:"items-center d-flex q-pa-xs",clickable:""},{default:a(()=>[o(v,{class:"hideonmobile col-auto no-margin"},{default:a(()=>[o(A,{class:"q-pa-none"},{default:a(()=>[this.mostrar.checkBox?(m(),f(v,{key:0,side:"",class:"col-auto q-pa-none"},{default:a(()=>[o(R,{modelValue:t.listaLayout[i.id].remover,"onUpdate:modelValue":p=>t.listaLayout[i.id].remover=p,onClick:e[9]||(e[9]=p=>r.verificarListaLayout())},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)):b("",!0),o(v,{side:"",class:"col-auto q-pa-none hideonmobile"},{default:a(()=>[_("div",Ve,[o(S,{id:i.id,numero:i.numero,dica:`Status: ${i.status}`,cor:i.status==="Ativo"?"positive":"tertiary"},null,8,["id","numero","dica","cor"])])]),_:2},1024)]),_:2},1024)]),_:2},1024),o(v,{class:"col-md col-lg col-xl no-margin"},{default:a(()=>[o(A,{class:"q-pa-none"},{default:a(()=>[o(v,{onClick:p=>r.abrirItem(i.id),class:"col-auto items-center"},{default:a(()=>[o(y,{rotulo:i.descricaoContato,tamanho:"40",style:{display:"flex","align-self":"center"}},null,8,["rotulo"]),this.mostrar.checkBox?(m(),f(R,{key:0,modelValue:t.listaLayout[i.id].remover,"onUpdate:modelValue":p=>t.listaLayout[i.id].remover=p,onClick:e[10]||(e[10]=p=>r.verificarListaLayout()),class:"hideondesktop q-mt-md"},null,8,["modelValue","onUpdate:modelValue"])):b("",!0)]),_:2},1032,["onClick"]),o(v,{class:"col"},{default:a(()=>[o(w,{onClick:p=>r.abrirItem(i.id),lines:"2",class:"text-weight-bold"},{default:a(()=>[_("span",null,[n(h(i.descricaoContato||"Sem descri\xE7\xE3o")+" ",1),o(q,{anchor:"bottom middle",self:"center middle"},{default:a(()=>e[14]||(e[14]=[n(" Descri\xE7\xE3o ")])),_:1})])]),_:2},1032,["onClick"]),i.descricaoEmpresa?(m(),f(w,{key:0,onClick:p=>r.abrirItem(i.id),caption:"",lines:"2"},{default:a(()=>[_("span",null,[o(E,{name:"business"}),n(" "+h(i.descricaoEmpresa)+" ",1),o(q,{anchor:"bottom middle",self:"center middle"},{default:a(()=>e[15]||(e[15]=[n(" Empresa ")])),_:1})])]),_:2},1032,["onClick"])):b("",!0),i.codigoDocumento?(m(),f(w,{key:1,caption:""},{default:a(()=>[o(S,{id:i.id,numero:i.numero,dica:`Status: ${i.status}`,class:"q-mr-sm hideondesktop",cor:i.status==="Ativo"?"positive":i.status==="Cancelado"?"tertiary":"light"},null,8,["id","numero","dica","cor"]),o(S,{id:String(i.codigoDocumento),numero:i.codigoDocumento,cor:"tertiary",dica:"C\xF3digo Documento"},null,8,["id","numero"])]),_:2},1024)):b("",!0),i.dataHoraEmissao?(m(),f(w,{key:2,onClick:p=>r.abrirItem(i.id),caption:"",class:"hideondesktop"},{default:a(()=>[o(E,{name:"mdi-calendar-today"}),_("span",xe,h(l.$filters.data(i.dataHoraEmissao)),1),n(" "+h(l.$filters.hora(i.dataHoraEmissao)),1)]),_:2},1032,["onClick"])):b("",!0),i.dataHoraFinalizado?(m(),f(w,{key:3,onClick:p=>r.abrirItem(i.id),caption:"",class:"hideondesktop"},{default:a(()=>[o(E,{name:"mdi-calendar"}),_("span",Ie,h(l.$filters.data(i.dataHoraFinalizado)),1),n(" "+h(l.$filters.hora(i.dataHoraFinalizado)),1)]),_:2},1032,["onClick"])):b("",!0),o(w,{class:"text-weight-bold text-right hideondesktop"},{default:a(()=>[n(h(l.$filters.numeroZerosDireita(i.totalContrato,4,2)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(v,{onClick:p=>r.abrirItem(i.id),class:"hideonmobile maxw100 q-pl-sm no-margin"},{default:a(()=>[i.dataHoraEmissao?(m(),f(w,{key:0,caption:"",class:"text-weight-medium"},{default:a(()=>[_("span",null,[o(E,{name:"mdi-calendar-today"}),n(" "+h(l.$filters.data(i.dataHoraEmissao))+" ",1),o(q,{anchor:"bottom middle",self:"center middle"},{default:a(()=>[n(" Emitido \xE1s "+h(l.$filters.hora(i.dataHoraEmissao)),1)]),_:2},1024)])]),_:2},1024)):b("",!0),i.dataHoraFinalizado?(m(),f(w,{key:1,caption:"",class:"text-weight-medium"},{default:a(()=>[_("span",null,[o(E,{name:"mdi-calendar"}),n(" "+h(l.$filters.data(i.dataHoraFinalizado))+" ",1),o(q,{anchor:"bottom middle",self:"center middle"},{default:a(()=>[n(" Finalizado \xE1s "+h(l.$filters.hora(i.dataHoraFinalizado)),1)]),_:2},1024)])]),_:2},1024)):b("",!0)]),_:2},1032,["onClick"]),o(v,{onClick:p=>r.abrirItem(i.id),class:"hideonmobile maxw140 q-pl-sm no-margin"},{default:a(()=>[o(w,{class:"text-weight-bold text-right"},{default:a(()=>[_("span",null,[n(h(l.$filters.numeroZerosDireita(i.totalContrato,4,2))+" ",1),o(q,{anchor:"bottom middle",self:"center middle"},{default:a(()=>e[16]||(e[16]=[n(" Valor do Contrato ")])),_:1})])]),_:2},1024)]),_:2},1032,["onClick"]),o(v,{class:"col-auto no-margin"},{default:a(()=>[o(A,{class:"q-pa-none"},{default:a(()=>[o(v,{class:"hideonmobile no-margin",style:{width:"32px"}},{default:a(()=>[o(V,{onClick:p=>r.abrirItem(i.id),icon:"edit",size:"md",color:"primary",round:"",flat:"",dense:""},null,8,["onClick"])]),_:2},1024),o(v,{class:"no-margin",style:{width:"32px"}},{default:a(()=>[i.status==="Ativo"?(m(),f(V,{key:0,icon:"more_vert",size:"md",round:"",flat:"",dense:""},{default:a(()=>[o(oe,null,{default:a(()=>[ue((m(),f(H,{link:"","no-border":"",separator:""},{default:a(()=>[i.status==="Ativo"?(m(),f(A,{key:0,onClick:p=>r.removerItem(i),clickable:""},{default:a(()=>[o(v,{avatar:""},{default:a(()=>[o(E,{name:"delete"})]),_:1}),o(v,null,{default:a(()=>e[17]||(e[17]=[n("Remover")])),_:1})]),_:2},1032,["onClick"])):b("",!0)]),_:2},1024)),[[me]])]),_:2},1024)]),_:2},1024)):b("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),i.id?(m(),f(te,{key:0})):b("",!0)]))),128))]),_:1})]),_:1},8,["busca","checkBox","onAtualizar","onCriarClick","onRemoverClick","onCheckBoxClick","onLimparFiltrosClick","lista","tabs","tabSelecionada","paginacao","mostrar"]),o(x,{onAtualizar:r.atualizar,ref:"contrato"},null,8,["onAtualizar"])])}var Ee=ee(ke,[["render",we]]);export{Ee as default};
